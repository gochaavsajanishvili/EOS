<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuma EOS Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background from React version */
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #menu-button {
            transition: left 0.3s ease-in-out;
        }
        #menu-button-icon {
            transition: transform 0.3s ease-in-out;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        .stat-card-icon {
            width: 3rem;
            height: 3rem;
        }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-panel {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-20 hidden md:hidden"></div>

    <div class="relative min-h-screen md:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-gray-950 text-gray-300 w-64 space-y-6 py-7 px-2 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 sidebar z-30 border-r border-gray-800">
            <a href="#" class="text-white flex items-center space-x-3 px-4">
                <svg class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                <span class="text-2xl font-extrabold">Zuma EOS</span>
            </a>

            <nav id="sidebar-nav" class="space-y-2">
                <!-- Nav links will be generated by JS -->
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <button id="menu-button" class="fixed top-1/2 -translate-y-1/2 left-0 z-40 bg-indigo-600 text-white w-8 h-16 flex items-center justify-center rounded-r-lg focus:outline-none shadow-lg md:hidden">
                 <svg id="menu-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="m9 18 6-6-6-6"/></svg>
            </button>
            <header class="flex justify-end items-center p-4 bg-gray-900 border-b border-gray-800">
                 <div class="flex items-center space-x-4">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                     <div class="flex items-center">
                         <img src="https://placehold.co/40x40/818CF8/111827?text=AY" alt="User Avatar" class="w-10 h-10 rounded-full">
                         <div class="ml-3">
                             <p class="text-sm font-semibold text-gray-100">Asfand Yaar</p>
                             <p class="text-xs text-gray-400">Visionary / Integrator</p>
                         </div>
                    </div>
                 </div>
            </header>
            
            <div id="main-scroll-area" class="flex-1 p-4 sm:p-6 overflow-y-auto">
                 <h1 id="page-title" class="text-3xl font-bold text-white mb-6">Dashboard</h1>
                 <main id="main-app">
                    <!-- Page content will be injected here -->
                 </main>
            </div>
        </div>
    </div>

    <script>
        // --- UTILITIES & HELPERS ---
        const UI = {
            showModal({ title, contentHTML, onSubmit, submitText = 'Submit' }) {
                const modalContainer = document.getElementById('modal-container');
                const modalHTML = `
                    <div id="modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 opacity-0">
                        <div id="modal-panel" class="modal-panel bg-gray-900 border border-gray-700 rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95 opacity-0">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white">${title}</h2>
                                <button id="modal-close" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
                            </div>
                            <div id="modal-content">${contentHTML}</div>
                            <div class="flex justify-end mt-6 space-x-4">
                                <button id="modal-cancel" class="bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600">Cancel</button>
                                <button id="modal-submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700">${submitText}</button>
                            </div>
                        </div>
                    </div>`;
                modalContainer.innerHTML = modalHTML;
                
                const overlay = document.getElementById('modal-overlay');
                const panel = document.getElementById('modal-panel');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    panel.classList.remove('scale-95', 'opacity-0');
                }, 10);

                document.getElementById('modal-close').onclick = () => UI.hideModal();
                document.getElementById('modal-cancel').onclick = () => UI.hideModal();
                overlay.onclick = (e) => { if (e.target === overlay) UI.hideModal(); };
                if (onSubmit) {
                    document.getElementById('modal-submit').onclick = () => {
                        const contentDiv = document.getElementById('modal-content');
                        onSubmit(contentDiv);
                    };
                }
            },
            hideModal() {
                const overlay = document.getElementById('modal-overlay');
                const panel = document.getElementById('modal-panel');
                if (!overlay || !panel) return;

                overlay.classList.add('opacity-0');
                panel.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            }
        };

        const Icons = {
            home: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            vision: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            departments: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>`,
            people: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            data: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>`,
            issues: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`,
            rocks: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.48 3.48a2 2 0 0 1 2.04 0l6 3.5A2 2 0 0 1 21 8.66v6.68a2 2 0 0 1-1.48 1.93l-6 3.5a2 2 0 0 1-2.04 0l-6-3.5A2 2 0 0 1 3 15.34V8.66a2 2 0 0 1 1.48-1.93l6-3.5Z"/><path d="m3.5 8.5 8.5 5 8.5-5"/><path d="M12 22V13.5"/></svg>`,
            meetings: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v5Z"/><path d="M18 9h2a2 2 0 0 1 2 2v11l-4-4h-6a2 2 0 0 1-2-2v-1"/></svg>`,
            ai: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>`,
            plus: () => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
            trash: () => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
        };

        const Persistence = {
            KEY: 'zuma_eos_state_v3',
            load() {
                try {
                    const storedState = localStorage.getItem(this.KEY);
                    if (storedState) return JSON.parse(storedState);
                    return null;
                } catch (e) {
                    console.error("Failed to load state from localStorage", e);
                    return null;
                }
            },
            save(state) {
                try {
                    localStorage.setItem(this.KEY, JSON.stringify(state));
                } catch (e) {
                    console.error("Failed to save state to localStorage", e);
                }
            }
        };

        const AI = {
            analyze(meetingHistory) {
                if (!meetingHistory || meetingHistory.length === 0) return "No meeting data available for analysis.";
                return "Analysis of recent meeting sentiment indicates a positive trend. Key recurring topics include Shopify performance and ULP development. The team consistently rates meetings highly, suggesting strong engagement. Continue monitoring 'Off Track' rocks as they are the primary drivers of negative sentiment dips.";
            }
        };

        const App = {
            data: {},
            
            getWeekId(date = new Date()) {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
                return `${d.getUTCFullYear()}-${String(weekNo).padStart(2, '0')}`;
            },

            init() {
                const loadedState = Persistence.load();
                if (loadedState) {
                    this.data = loadedState;
                } else {
                    this.data = {
                        companyName: "Zuma",
                        vto: {
                            coreValues: ["Customer First", "Innovate & Simplify", "Own It", "Get It Done Right", "Team Player"],
                            coreFocus: { purpose: "To be the most trusted and efficient online source for aerial lift equipment and parts.", niche: "Providing high-quality used aerial lifts and parts with exceptional digital experience." },
                            tenYearTarget: "To be the #1 online destination for aerial lifts in North America.",
                            marketingStrategy: { targetMarket: "Construction companies, equipment rental businesses, and maintenance contractors in North America.", threeUniques: ["Unified Listing Platform for maximum reach", "In-house tech for superior customer experience (TIP)", "Deep industry expertise and transparent inspections."], provenProcess: "Source -> Inspect (TIP) -> Repair -> List (ULP) -> Sell -> Ship -> Support.", guarantee: "30-day parts warranty on all repaired machines." },
                            threeYearPicture: "Achieve $50M in annual revenue. ULP lists on 10+ platforms. TIP is used by 5 external partners.",
                            oneYearPlan: ["Launch zumasales.com v3 on Shopify Plus.", "Integrate Odoo with ULP for real-time inventory.", "Reduce average repair time by 15% using TIP data.", "Increase organic traffic to zuma.ca by 40%."]
                        },
                        scorecard: [
                            { metric: "Shopify Sales ($)", goal: "150000", value: "165000", trend: [140, 155, 148, 165] },
                            { metric: "ULP Listings Created", goal: "50", value: "45", trend: [52, 55, 48, 45] },
                            { metric: "Machines Inspected (TIP)", goal: "25", value: "28", trend: [22, 24, 26, 28] },
                            { metric: "Website Leads (zuma.ca)", goal: "100", value: "110", trend: [95, 105, 98, 110] },
                            { metric: "Customer Satisfaction (CSAT %)", goal: "95", value: "96", trend: [94, 95, 96, 96] },
                        ],
                        scorecardHistory: {},
                        companyRocks: [
                            { id: 1, title: "ULP Craigslist Integration", owner: "Asfand Yaar", status: "On Track", team: "Dev" },
                            { id: 2, title: "Q4 SEO Strategy for zuma.ca", owner: "Hamza Khan", status: "On Track", team: "Marketing" },
                            { id: 3, title: "Streamline Shopify-Odoo Order Sync", owner: "Gocha Avsajanishvili", status: "Off Track", team: "Dev" },
                            { id: 4, title: "Implement new TIP inspection template", owner: "Asfand Yaar", status: "Done", team: "Ops" },
                        ],
                        issues: [
                            { id: 1, title: "Odoo sync with Shopify is lagging by 30 mins", priority: 1, age: 5 },
                            { id: 2, title: "Need to define Q4 marketing budget for new ad campaigns", priority: 2, age: 12 },
                        ],
                        meetingHistory: [
                            { date: "Sep 22, 2025", rating: 9, sentiment: 85, keyTopics: ["Shopify Sync", "Marketing Budget"], completedTodos: [], message: "Tech team will provide an update on the sync fix next week." },
                            { date: "Sep 15, 2025", rating: 8, sentiment: 82, keyTopics: ["TIP Photos", "Sales Pipeline"], completedTodos: [{id: 101, task: "Follow up with new lead from Texas"}], message: "Sales to action new leads from the conference." },
                            { date: "Sep 8, 2025", rating: 8, sentiment: 88, keyTopics: ["ULP Performance", "New Hires"], completedTodos: [], message: "HR to start the hiring process for the new writer role." },
                        ],
                        departments: {
                            technology: { name: "Technology", head: "Asfand Yaar", members: ["Gocha Avsajanishvili", "Prince Ezra", "Akash", "Saeed Ahmed", "JC Vergara"] },
                            marketing: { name: "Marketing", head: "Hamza Khan", members: ["UX Designer", "SEO Writer", "Ads Specialist"] },
                            operations: { name: "Operations", head: "Asfand Yaar (Interim)", members: ["Sales Team", "Repair Team", "Shipping Team"] },
                        }
                    };
                    Persistence.save(this.data);
                }
                
                this.data.l10Data = {
                    lastWeeksToDos: [{ id: 1, task: "Review Q3 Marketing Graphics", assignee: "Hamza K.", completed: false }, { id: 2, task: "Finalize server spec for ULP v2", assignee: "Gocha A.", completed: false }],
                    currentToDos: [],
                    meetingIssues: JSON.parse(JSON.stringify(this.data.issues || [])),
                };
                
                this.renderSidebar();
                this.router();
                window.addEventListener('hashchange', this.router.bind(this));
                
                const menuButton = document.getElementById('menu-button');
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const menuIcon = document.getElementById('menu-button-icon');
                const toggleSidebar = () => {
                    const isOpen = !sidebar.classList.contains('-translate-x-full');
                    if (isOpen) {
                        sidebar.classList.add('-translate-x-full');
                        overlay.classList.add('hidden');
                        menuIcon.classList.remove('rotate-180');
                        menuButton.classList.remove('left-64'); menuButton.classList.add('left-0');
                    } else {
                        sidebar.classList.remove('-translate-x-full');
                        overlay.classList.remove('hidden');
                        menuIcon.classList.add('rotate-180');
                        menuButton.classList.remove('left-0'); menuButton.classList.add('left-64');
                    }
                };
                menuButton.addEventListener('click', toggleSidebar);
                overlay.addEventListener('click', toggleSidebar);

                // Event delegation for dynamically added elements
                document.body.addEventListener('change', (e) => {
                    if (e.target.classList.contains('rock-status-select')) {
                        const rockId = parseInt(e.target.dataset.rockId);
                        const rock = App.data.companyRocks.find(r => r.id === rockId);
                        if (rock) {
                            rock.status = e.target.value;
                            Persistence.save(App.data);
                            App.render('rocks');
                        }
                    }
                    if (e.target.classList.contains('scorecard-input')) {
                        const index = parseInt(e.target.dataset.index);
                        App.data.scorecard[index].value = e.target.value;
                        Persistence.save(App.data);
                    }
                });

                document.body.addEventListener('click', (e) => {
                     if (e.target.id === 'save-snapshot-btn') {
                        const weekId = App.getWeekId();
                        App.data.scorecardHistory[weekId] = JSON.parse(JSON.stringify(App.data.scorecard));
                        Persistence.save(App.data);
                        alert(`Snapshot for week ${weekId} saved!`);
                    }
                });
            },
            
            renderSidebar() {
                const navLinks = [
                    { href: '#dashboard', icon: Icons.home(), text: 'Dashboard' },
                    { href: '#vto', icon: Icons.vision(), text: 'V/TO' },
                    { href: '#departments', icon: Icons.departments(), text: 'Departments' },
                    { href: '#people', icon: Icons.people(), text: 'People' },
                    { href: '#data', icon: Icons.data(), text: 'Data' },
                    { href: '#issues', icon: Icons.issues(), text: 'Issues' },
                    { href: '#rocks', icon: Icons.rocks(), text: 'Rocks' },
                    { href: '#l10', icon: Icons.meetings(), text: 'Level 10 Meeting', isSpecial: true },
                ];
                const navContainer = document.getElementById('sidebar-nav');
                navContainer.innerHTML = navLinks.map(link => `
                    <a href="${link.href}" class="nav-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-gray-800 ${link.isSpecial ? 'bg-indigo-600 font-bold text-white hover:bg-indigo-700' : ''}">
                        <span class="w-6 mr-3">${link.icon}</span> ${link.text}
                    </a>`).join('');
            },

            navigate(hash, param) {
                const newLocation = param ? `${hash}/${param}` : hash;
                window.location.hash = newLocation;
            },
            
            router() {
                const [hash, param] = (window.location.hash || '#dashboard').split('/');
                const pageTitle = document.getElementById('page-title');

                document.querySelectorAll('.nav-link.active').forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
                if (activeLink) activeLink.classList.add('active');

                const sidebar = document.getElementById('sidebar');
                if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                    document.getElementById('menu-button').click();
                }
                document.getElementById('main-scroll-area').scrollTop = 0;

                if (hash === '#departments' && param) {
                    const deptName = this.data.departments[param]?.name || 'Departments';
                    pageTitle.textContent = `${deptName} Department`;
                    this.render('departmentDetail', param);
                    return;
                }

                const routes = {
                    '#dashboard': { title: 'Dashboard', page: 'dashboard' },
                    '#vto': { title: 'Vision/Traction Organizer', page: 'vto' },
                    '#departments': { title: 'Departments', page: 'departments' },
                    '#people': { title: 'People', page: 'people' },
                    '#data': { title: 'Data', page: 'data' },
                    '#issues': { title: 'Issues', page: 'issues' },
                    '#rocks': { title: 'Rocks', page: 'rocks' },
                    '#l10': { title: 'Level 10 Meeting', page: 'l10' },
                };

                const route = routes[hash] || routes['#dashboard'];
                pageTitle.textContent = route.title;
                this.render(route.page, param);
            },
            
            render(page, param) {
                const mainApp = document.getElementById('main-app');
                mainApp.innerHTML = this.pages[page](param);
                if (page === 'dashboard' || page === 'data') {
                    setTimeout(() => this.renderCharts(), 0);
                }
                if(page === 'l10') this.initL10();
            },
            
            pages: {
                dashboard() {
                    const { scorecard, companyRocks, issues, meetingHistory } = App.data;
                    const getNumber = (value) => {
                        const parsed = parseFloat(String(value ?? '').replace(/[^0-9.-]/g, ''));
                        return Number.isFinite(parsed) ? parsed : 0;
                    };
                    const salesMetric = scorecard[0] || {};
                    const csatMetric = scorecard.find(item => item.metric.toLowerCase().includes('csat')) || {};
                    const onTrackRocks = companyRocks.filter(rock => rock.status === 'On Track' || rock.status === 'Done').length;
                    const salesValue = getNumber(salesMetric.value);
                    const salesGoal = getNumber(salesMetric.goal);
                    const salesDelta = salesGoal ? ((salesValue - salesGoal) / salesGoal) * 100 : 0;
                    const csatValue = getNumber(csatMetric.value);
                    const csatGoal = getNumber(csatMetric.goal);
                    const csatDelta = csatGoal ? csatValue - csatGoal : 0;
                    const highPriorityIssues = issues.filter(issue => issue.priority === 1).length;
                    const topIssues = issues.slice().sort((a, b) => a.priority - b.priority).slice(0, 3);

                    return `
                        <div class="bg-indigo-900/50 border border-indigo-500/30 text-white p-6 rounded-lg shadow-lg mb-6">
                            <div class="flex items-start">
                                <span class="mr-4 mt-1 text-indigo-400">${Icons.ai()}</span>
                                <div>
                                    <h3 class="font-bold text-xl text-indigo-300">AI Analyst Summary</h3>
                                    <p class="text-indigo-200/80 mt-2">${AI.analyze(App.data.meetingHistory)}</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                            <div class="xl:col-span-2 space-y-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                        <p class="text-sm text-gray-400 font-medium">Shopify Sales (Weekly)</p>
                                        <p class="text-2xl font-bold text-white mt-2">$${salesValue.toLocaleString()}</p>
                                        <p class="text-sm ${salesDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'} mt-1">${salesGoal ? `${salesDelta >= 0 ? '+' : ''}${Math.round(salesDelta)}% vs goal` : 'Goal not set'}</p>
                                    </div>
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                        <p class="text-sm text-gray-400 font-medium">Rocks On Track</p>
                                        <p class="text-2xl font-bold text-white mt-2">${onTrackRocks} / ${companyRocks.length}</p>
                                        <p class="text-sm text-gray-400 mt-1">${companyRocks.length ? Math.round((onTrackRocks / companyRocks.length) * 100) : 0}% completion</p>
                                    </div>
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                        <p class="text-sm text-gray-400 font-medium">Open Issues</p>
                                        <p class="text-2xl font-bold text-white mt-2">${issues.length}</p>
                                        <p class="text-sm text-amber-400 mt-1">${highPriorityIssues} priority 1</p>
                                    </div>
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                        <p class="text-sm text-gray-400 font-medium">Customer Satisfaction</p>
                                        <p class="text-2xl font-bold ${csatDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'} mt-2">${csatMetric.value ?? '--'}%</p>
                                        <p class="text-sm text-gray-400 mt-1">Goal: ${csatMetric.goal ?? '--'}%</p>
                                    </div>
                                </div>

                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-semibold text-white text-lg">Sales Trend</h3>
                                        <span class="text-sm text-gray-400">Last 4 weeks</span>
                                    </div>
                                    <canvas id="salesChart" class="h-48"></canvas>
                                </div>

                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="font-semibold text-white text-lg mb-4">Scorecard Snapshot</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                        ${scorecard.map(item => {
                                            const goal = getNumber(item.goal);
                                            const value = getNumber(item.value);
                                            const isTimeMetric = item.metric.toLowerCase().includes('time');
                                            const onTarget = isTimeMetric ? value <= goal : value >= goal;
                                            return `
                                                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 flex justify-between items-center">
                                                    <div>
                                                        <p class="text-sm text-gray-400">${item.metric}</p>
                                                        <p class="text-xl font-semibold ${onTarget ? 'text-emerald-400' : 'text-rose-400'}">${item.value}</p>
                                                        <p class="text-xs text-gray-500">Goal: ${item.goal}</p>
                                                    </div>
                                                    <div class="w-24 h-12">
                                                        <canvas class="scorecard-chart" data-trend='${JSON.stringify(item.trend)}' data-good="${onTarget}"></canvas>
                                                    </div>
                                                </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="font-semibold text-white text-lg mb-4">Recent L10 Meetings</h3>
                                    <ul class="space-y-3">
                                        ${meetingHistory.slice(0, 3).map(meeting => `
                                            <li class="flex justify-between items-center p-3 bg-gray-900/60 rounded-md">
                                                <div>
                                                    <p class="font-semibold text-gray-200">${meeting.date}</p>
                                                    <p class="text-sm text-gray-400">${meeting.keyTopics.join(', ')}</p>
                                                </div>
                                                <span class="text-sm font-bold text-indigo-400">Rating: ${meeting.rating}/10</span>
                                            </li>`).join('') || '<li class="text-gray-500">No meetings logged.</li>'}
                                    </ul>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="font-semibold text-white text-lg mb-4">Top Issues To Discuss</h3>
                                    <ul class="space-y-3">
                                        ${topIssues.map(issue => `
                                            <li class="bg-gray-900/60 border border-gray-800 rounded-md p-3">
                                                <p class="font-semibold text-gray-200">${issue.title}</p>
                                                <p class="text-xs text-gray-400">Priority ${issue.priority} &amp;bull; Age ${issue.age} days</p>
                                            </li>`).join('') || '<li class="text-gray-500">All clear for now.</li>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                },
                vto() {
                    return `<div class="bg-gray-800 border border-gray-700 p-6 sm:p-8 rounded-lg shadow"><div class="text-center mb-8"><h2 class="text-3xl font-bold text-white">Vision/Traction Organizer&trade;</h2><p class="text-gray-400">for ${App.data.companyName}</p></div><div class="space-y-8">${Object.entries({
                        "Core Values": `<div class="flex flex-wrap gap-3">${App.data.vto.coreValues.map(v => `<span class="bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-full text-sm font-medium">${v}</span>`).join('')}</div>`,
                        "Core Focus&trade;": `<p><strong class="font-medium text-gray-300">Purpose/Cause/Passion:</strong> ${App.data.vto.coreFocus.purpose}</p><p><strong class="font-medium text-gray-300">Our Niche:</strong> ${App.data.vto.coreFocus.niche}</p>`,
                        "10-Year Target&trade;": `<p>${App.data.vto.tenYearTarget}</p>`,
                        "Marketing Strategy&trade;": `<p><strong class="font-medium text-gray-300">Target Market:</strong> ${App.data.vto.marketingStrategy.targetMarket}</p><p class="mt-2"><strong class="font-medium text-gray-300">Three Uniques&trade;:</strong></p><ul class="list-disc list-inside ml-4">${App.data.vto.marketingStrategy.threeUniques.map(u => `<li>${u}</li>`).join('')}</ul>`,
                        "3-Year Picture&trade;": `<p>${App.data.vto.threeYearPicture}</p>`,
                        "1-Year Plan&trade;": `<ul class="list-disc list-inside space-y-1">${App.data.vto.oneYearPlan.map(p => `<li>${p}</li>`).join('')}</ul>`
                    }).map(([title, content]) => `<div><h3 class="text-xl font-semibold text-indigo-400 border-b border-gray-700 pb-2 mb-3">${title}</h3><div class="text-gray-300">${content}</div></div>`).join('')}</div></div>`;
                },
                 people() { 
                    return `<div class="bg-gray-800 border border-gray-700 p-6 sm:p-8 rounded-lg shadow">
                        <h2 class="text-2xl font-bold text-white mb-6">Accountability Chart</h2>
                        <div class="overflow-x-auto p-4">
                            <div class="flex flex-col items-center">
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-center w-64">
                                    <p class="font-bold text-lg text-white">Visionary / Integrator</p>
                                    <p class="text-gray-400">Asfand Yaar</p>
                                </div>
                                <div class="h-8 w-px bg-gray-700"></div>
                                <div class="w-full border-t-2 border-gray-700"></div>
                                <div class="flex flex-wrap justify-center pt-8">
                                    ${Object.values(App.data.departments).map(dept => `
                                    <div class="flex flex-col items-center mx-4 my-4">
                                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-center w-48">
                                            <p class="font-bold text-white">${dept.name}</p>
                                            <p class="text-gray-400">${dept.head}</p>
                                        </div>
                                        <div class="h-8 w-px bg-gray-700"></div>
                                        <div class="flex flex-wrap justify-center w-48">
                                            ${dept.members.map(m => `<span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 m-1 rounded-full">${m}</span>`).join('')}
                                        </div>
                                    </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>`;
                },
                issues() { 
                    return `<div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-white">Company Issues List</h2><button class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700">Add Issue</button></div>
                        <ul class="space-y-3">
                        ${App.data.issues.sort((a,b) => a.priority - b.priority).map(issue => `
                            <li class="p-4 bg-gray-900/50 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-gray-200">${issue.title}</p>
                                    <p class="text-sm text-gray-400">Priority: ${issue.priority} &bull; Age: ${issue.age} days</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="text-gray-400 hover:text-indigo-400 p-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button>
                                    <button class="text-gray-400 hover:text-green-400 p-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                                </div>
                            </li>`).join('')}
                        </ul>
                    </div>`;
                },
                departments() {
                    return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${Object.keys(App.data.departments).map(key => {
                        const dept = App.data.departments[key];
                        const rockCount = Array.isArray(dept.rocks) ? dept.rocks.length : 0;
                        return `<a href="#departments/${key}" class="block bg-gray-800 border border-gray-700 p-6 rounded-lg shadow hover:border-indigo-500 transition-colors">
                                <h3 class="text-xl font-bold text-indigo-300">${dept.name}</h3>
                                <p class="text-gray-400 mt-1">Headed by: ${dept.head}</p>
                                <div class="mt-4 text-sm text-gray-500 space-y-1">
                                    <p>${dept.members.length} Team Members</p>
                                    <p>${rockCount} Rocks</p>
                                </div>
                            </a>`;
                    }).join('')}</div>`;
                },
                departmentDetail(deptKey) {
                    const dept = App.data.departments[deptKey];
                    if (!dept) return `<p class="text-gray-400">Department not found.</p>`;
                    const getNumber = (value) => {
                        const parsed = parseFloat(String(value ?? '').replace(/[^0-9.-]/g, ''));
                        return Number.isFinite(parsed) ? parsed : 0;
                    };
                    return `<div><a href="#departments" class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block">&larr; Back to all departments</a></div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Rocks</h3>
                                    <ul class="space-y-3">${(dept.rocks || []).map(rock => `
                                        <li class="p-3 border rounded-lg flex justify-between items-center ${rock.status === 'Off Track' ? 'border-rose-500/40 bg-rose-500/10' : rock.status === 'Done' ? 'border-indigo-500/30 bg-indigo-500/10' : 'border-emerald-500/30 bg-emerald-500/10'}">
                                            <div>
                                                <p class="font-semibold text-gray-100">${rock.title}</p>
                                                <p class="text-xs text-gray-400">${rock.owner}</p>
                                            </div>
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-900/60 text-gray-200">${rock.status}</span>
                                        </li>`).join('') || '<li class="text-gray-500">No rocks assigned.</li>'}</ul>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Scorecard</h3>
                                    <ul class="space-y-2">${(dept.scorecard || []).map(item => {
                                        const goal = getNumber(item.goal);
                                        const value = getNumber(item.value);
                                        const isTimeMetric = item.metric.toLowerCase().includes('time');
                                        const onTarget = isTimeMetric ? value <= goal : value >= goal;
                                        return `<li class="flex justify-between items-center p-3 rounded border ${onTarget ? 'border-emerald-500/30 bg-emerald-500/10' : 'border-rose-500/40 bg-rose-500/10'}">
                                                <span class="text-gray-200">${item.metric}</span>
                                                <div class="text-right">
                                                    <p class="font-semibold text-white">${item.value}</p>
                                                    <p class="text-xs text-gray-400">Goal: ${item.goal}</p>
                                                </div>
                                            </li>`;
                                    }).join('') || '<li class="text-gray-500">No scorecard metrics yet.</li>'}</ul>
                                </div>
                            </div>
                            <div class="space-y-6">
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Team</h3>
                                    <ul class="space-y-2">
                                        <li class="font-semibold text-gray-100">${dept.head} <span class="text-xs text-gray-400">(Head)</span></li>
                                        ${(dept.members || []).map(member => `<li class="text-gray-300">${member}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Issues</h3>
                                    <ul class="space-y-2 list-disc list-inside text-gray-300">${(dept.issues || []).map(issue => `<li>${issue.title}</li>`).join('') || '<li class="text-gray-500">No issues reported.</li>'}</ul>
                                </div>
                            </div>
                        </div>`;
                },
                rocks() {
                    const statusColors = { "On Track": "border-blue-500", "Off Track": "border-red-500", "Done": "border-green-500" };
                    return `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Company Rocks</h2></div>
                        <div class="space-y-4">
                        ${App.data.companyRocks.map(rock => `
                            <div class="bg-gray-800 border-l-4 ${statusColors[rock.status]} rounded-r-lg p-4 flex flex-col sm:flex-row justify-between sm:items-center">
                                <div class="mb-4 sm:mb-0">
                                    <p class="font-semibold text-lg text-white">${rock.title}</p>
                                    <span class="text-sm text-gray-400">${rock.owner}</span>
                                </div>
                                <div class="flex items-center space-x-2 self-end sm:self-center">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${rock.team === 'Dev' ? 'bg-purple-500/20 text-purple-300' : rock.team === 'Marketing' ? 'bg-pink-500/20 text-pink-300' : 'bg-yellow-500/20 text-yellow-300'}">${rock.team}</span>
                                    <select class="rock-status-select bg-gray-700 border border-gray-600 rounded-md p-1 text-sm" data-rock-id="${rock.id}">
                                        <option value="On Track" ${rock.status === 'On Track' ? 'selected' : ''}>On Track</option>
                                        <option value="Off Track" ${rock.status === 'Off Track' ? 'selected' : ''}>Off Track</option>
                                        <option value="Done" ${rock.status === 'Done' ? 'selected' : ''}>Done</option>
                                    </select>
                                </div>
                            </div>`).join('')}
                        </div>`;
                },
                data() {
                    return `<div class="space-y-6">
                        <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                                <h2 class="text-2xl font-bold text-white">Company Scorecard</h2>
                                <button id="save-snapshot-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-500">Save as This Week's Snapshot</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-900/60">
                                        <tr>
                                            <th class="p-4 font-semibold text-gray-300">Metric</th>
                                            <th class="p-4 font-semibold text-gray-300">Goal</th>
                                            <th class="p-4 font-semibold text-gray-300">Actual</th>
                                            <th class="p-4 font-semibold text-gray-300">Trend (4 weeks)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${App.data.scorecard.map((item, index) => {
                                            const numGoal = parseFloat(String(item.goal).replace(/[^0-9.-]/g, '')) || 0;
                                            const numValue = parseFloat(String(item.value).replace(/[^0-9.-]/g, '')) || 0;
                                            const isTimeMetric = item.metric.toLowerCase().includes('time');
                                            const onTarget = isTimeMetric ? numValue <= numGoal : numValue >= numGoal;
                                            return `
                                                <tr class="border-b border-gray-700 hover:bg-gray-900/40">
                                                    <td class="p-4 font-medium text-gray-200">${item.metric}</td>
                                                    <td class="p-4 text-gray-400">${item.goal}</td>
                                                    <td class="p-4">
                                                        <input type="text" class="scorecard-input bg-gray-900 border border-gray-700 rounded-md p-2 w-28 text-right text-gray-200" value="${item.value}" data-index="${index}">
                                                    </td>
                                                    <td class="p-4">
                                                        <div class="w-28 h-16">
                                                            <canvas class="scorecard-chart" data-trend='${JSON.stringify(item.trend)}' data-good="${onTarget}"></canvas>
                                                        </div>
                                                    </td>
                                                </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                },
                l10() {
                    return `<div class="flex border-b border-gray-700 mb-4"><button id="l10-tab-live" class="px-4 py-2 font-semibold border-b-2 border-indigo-500 text-indigo-400">Live Meeting</button><button id="l10-tab-history" class="px-4 py-2 font-semibold text-gray-500 hover:text-gray-300">History & AI Insights</button></div><div id="l10-content"></div>`;
                },
            },
            
            renderCharts() {
                const salesCanvas = document.getElementById('salesChart');
                if (salesCanvas && App.data.scorecard[0]?.trend) {
                    new Chart(salesCanvas, {
                        type: 'line',
                        data: {
                            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                            datasets: [{
                                label: 'Weekly Sales ($)',
                                data: App.data.scorecard[0].trend.map(value => value * 1000),
                                borderColor: '#6366F1',
                                backgroundColor: 'rgba(99, 102, 241, 0.15)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(148, 163, 184, 0.15)' } },
                                y: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(148, 163, 184, 0.15)' } }
                            }
                        }
                    });
                }

                document.querySelectorAll('.scorecard-chart').forEach(canvas => {
                    const trendData = JSON.parse(canvas.dataset.trend || '[]');
                    const isGood = canvas.dataset.good === 'true';
                    new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: Array(trendData.length).fill(''),
                            datasets: [{
                                data: trendData,
                                borderColor: isGood ? '#34D399' : '#F87171',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                });
            },

            initL10() {
                const liveTab = document.getElementById('l10-tab-live');
                const historyTab = document.getElementById('l10-tab-history');
                const contentContainer = document.getElementById('l10-content');
                let timerInterval;
                let currentStep = 0;

                const addIssue = (title, priority = 3) => {
                    if (!title || !title.trim()) return;
                    const newIssue = { id: Date.now(), title: title.trim(), priority, age: 0 };
                    App.data.l10Data.meetingIssues.push(newIssue);
                    App.data.l10Data.meetingIssues.sort((a, b) => a.priority - b.priority);
                    Persistence.save(App.data);
                    renderL10Step();
                };

                const addToDo = (task, assignee) => {
                    if (!task || !task.trim() || !assignee || !assignee.trim()) return;
                    const newTodo = { id: Date.now(), task: task.trim(), assignee: assignee.trim(), dueDate: 'Next Week', completed: false };
                    App.data.l10Data.currentToDos.push(newTodo);
                    Persistence.save(App.data);
                    renderL10Step();
                };

                const L10_CONTENT = {
                    segue: () => `<h4 class="font-bold text-gray-100 mb-2">Good News</h4><p class="text-gray-400 mb-4">Each team member shares one personal and one business win from the past week.</p><textarea class="w-full p-3 border border-gray-700 rounded bg-gray-900 text-gray-100 focus:outline-none focus:border-indigo-500" rows="4" placeholder="Capture notes here..."></textarea>`,
                    scorecard: () => `${App.data.scorecard.map((item, index) => {
                        const goal = parseFloat(String(item.goal).replace(/[^0-9.-]/g, '')) || 0;
                        const value = parseFloat(String(item.value).replace(/[^0-9.-]/g, '')) || 0;
                        const isTimeMetric = item.metric.toLowerCase().includes('time');
                        const onTarget = isTimeMetric ? value <= goal : value >= goal;
                        return `<div class="flex flex-col sm:flex-row justify-between sm:items-center p-3 rounded border ${onTarget ? 'border-emerald-500/30 bg-emerald-500/10' : 'border-rose-500/40 bg-rose-500/10'}">
                                    <span class="font-medium text-gray-100 mb-2 sm:mb-0">${item.metric}</span>
                                    <div class="flex items-center space-x-3">
                                        <span class="text-sm text-gray-400">Goal: ${item.goal}</span>
                                        <input type="text" value="${item.value}" class="w-24 p-2 border border-gray-700 rounded bg-gray-900 text-right text-gray-100 focus:outline-none focus:border-indigo-500" data-metric-index="${index}">
                                        ${onTarget ? '' : `<button class="add-to-ids-btn text-xs bg-yellow-500 text-gray-900 px-2 py-1 rounded hover:bg-yellow-400" data-issue-title="${item.metric} is off track">Add to IDS</button>`}
                                    </div>
                                </div>`;
                    }).join('')}`,
                    rockReview: () => `${App.data.companyRocks.map(rock => `<div class="flex justify-between items-center p-3 rounded border ${rock.status === 'Off Track' ? 'border-rose-500/40 bg-rose-500/10' : rock.status === 'Done' ? 'border-indigo-500/30 bg-indigo-500/10' : 'border-emerald-500/30 bg-emerald-500/10'}">
                                <div>
                                    <p class="font-semibold text-gray-100">${rock.title}</p>
                                    <p class="text-xs text-gray-400">${rock.owner}</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer toggle-checkbox" data-rock-id="${rock.id}" ${rock.status === 'On Track' ? 'checked' : ''}>
                                    <div class="w-12 h-6 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 transition-colors"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-6"></div>
                                </label>
                            </div>`).join('')}`,
                    headlines: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-bold text-gray-100 mb-2">Customer Headlines</h4>
                                    <textarea id="customer-headline" class="w-full p-3 border border-gray-700 rounded bg-gray-900 text-gray-100 focus:outline-none focus:border-indigo-500" rows="3" placeholder="Customer wins or issues..."></textarea>
                                    <button class="add-headline-btn mt-2 text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-500" data-source="customer-headline">Add to IDS</button>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-100 mb-2">Employee Headlines</h4>
                                    <textarea id="employee-headline" class="w-full p-3 border border-gray-700 rounded bg-gray-900 text-gray-100 focus:outline-none focus:border-indigo-500" rows="3" placeholder="Team shout-outs or concerns..."></textarea>
                                    <button class="add-headline-btn mt-2 text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-500" data-source="employee-headline">Add to IDS</button>
                                </div>
                            </div>`,
                    toDoList: () => {
                        const openTodos = App.data.l10Data.lastWeeksToDos.filter(todo => !todo.completed);
                        return `<h4 class="font-bold text-gray-100 mb-2">To-Do List</h4>
                                <p class="text-gray-400 mb-4">Review last week's commitments. Goal is 90% completion.</p>
                                <div id="last-week-todos">
                                    <h5 class="font-semibold text-sm text-gray-400 mb-2">From Last Week</h5>
                                    ${openTodos.length ? openTodos.map(todo => `<div class="flex items-center justify-between p-3 border border-gray-700 bg-gray-900/60 rounded mb-2 transition">
                                                <label class="flex items-center space-x-3 text-gray-100">
                                                    <input type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-800" data-todo-id="${todo.id}">
                                                    <span>
                                                        <p>${todo.task}</p>
                                                        <p class="text-xs text-gray-400">${todo.assignee} &ndash; Due ${todo.dueDate}</p>
                                                    </span>
                                                </label>
                                            </div>`).join('') : '<p class="text-gray-500 text-sm">All done!</p>'}
                                </div>
                                <div id="current-todos" class="mt-4">
                                    <h5 class="font-semibold text-sm text-gray-400 mb-2">New To-Dos (This Meeting)</h5>
                                    ${App.data.l10Data.currentToDos.length ? App.data.l10Data.currentToDos.map(todo => `<div class="flex items-center justify-between p-3 border border-amber-500/40 bg-amber-500/10 rounded mb-2">
                                                <div>
                                                    <p class="text-gray-100">${todo.task}</p>
                                                    <p class="text-xs text-gray-400">${todo.assignee}</p>
                                                </div>
                                                <button class="delete-todo-btn text-rose-400 hover:text-rose-300 text-xl font-bold p-1" data-todo-id="${todo.id}">&times;</button>
                                            </div>`).join('') : '<p class="text-gray-500 text-sm">No new to-dos yet.</p>'}
                                </div>`;
                    },
                    ids: () => `<h4 class="font-bold text-gray-100 mb-2">Identify, Discuss, Solve (IDS)</h4><p class="text-gray-400 mb-4">Work the list in priority order. Convert decisions into to-dos as needed.</p><div id="issues-list" class="space-y-3 mb-4">${App.data.l10Data.meetingIssues.map(issue => `<div class="p-4 border border-gray-700 rounded-lg bg-gray-900/80 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <p class="font-semibold text-gray-100 mb-3 sm:mb-0">${issue.priority}. ${issue.title}</p>
                                <button class="add-todo-from-ids-btn text-xs bg-emerald-500 text-gray-900 px-3 py-1 rounded hover:bg-emerald-400 self-start sm:self-center" data-issue-title="${issue.title}">Add a To-Do</button>
                            </div>`).join('') || '<p class="text-gray-500">No issues on the board.</p>'}</div><div class="flex space-x-3"><input id="manual-issue-input" type="text" class="flex-grow p-3 border border-gray-700 rounded bg-gray-900 text-gray-100 focus:outline-none focus:border-indigo-500" placeholder="Manually add a new issue..."><button id="add-manual-issue-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-500">Add</button></div>`,
                    conclude: () => `<h4 class="font-bold text-gray-100 mb-2">Conclude</h4><p class="text-gray-400 mb-4">Recap the new to-dos, confirm cascading messages, and rate the meeting.</p><p class="font-semibold text-gray-100">New To-Dos Created: ${App.data.l10Data.currentToDos.length}</p><label class="block mt-3 text-sm text-gray-300">Cascading Message<textarea class="w-full mt-2 p-3 border border-gray-700 rounded bg-gray-900 text-gray-100 focus:outline-none focus:border-indigo-500" rows="3" placeholder="Example: Tech team is prioritizing the Shopify sync fix."></textarea></label><p class="mt-4 text-center text-2xl font-bold text-indigo-300">Meeting Rating: ___ / 10</p>`
                };

                const steps = [
                    { title: 'Welcome', duration: 0, content: () => `<p class="text-center text-gray-300">This is a guided simulation of a 90 minute Level 10 Meeting.</p><button id="start-l10" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-semibold">Start Meeting</button>` },
                    { title: 'Segue', duration: 300, content: L10_CONTENT.segue },
                    { title: 'Scorecard', duration: 300, content: () => `<h4 class="font-bold text-gray-100 mb-4">Scorecard Review</h4>${L10_CONTENT.scorecard()}` },
                    { title: 'Rock Review', duration: 300, content: () => `<h4 class="font-bold text-gray-100 mb-4">Rock Review</h4>${L10_CONTENT.rockReview()}` },
                    { title: 'Headlines', duration: 300, content: L10_CONTENT.headlines },
                    { title: 'To-Do List', duration: 300, content: L10_CONTENT.toDoList },
                    { title: 'IDS', duration: 3600, content: L10_CONTENT.ids },
                    { title: 'Conclude', duration: 300, content: L10_CONTENT.conclude },
                ];

                const startTimer = (duration) => {
                    if (timerInterval) clearInterval(timerInterval);
                    const timerEl = document.getElementById('timer');
                    if (!timerEl) return;
                    if (!duration) { timerEl.textContent = '00:00'; return; }
                    let time = duration;
                    timerInterval = setInterval(() => {
                        const minutes = Math.floor(time / 60);
                        const seconds = time % 60;
                        timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        if (time-- <= 0) clearInterval(timerInterval);
                    }, 1000);
                };

                const renderL10Step = () => {
                    const step = steps[currentStep];
                    contentContainer.innerHTML = `
                        <div class="bg-gray-900 border border-gray-800 p-6 sm:p-8 rounded-xl shadow-inner space-y-6">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl sm:text-2xl font-bold text-white">${step.title}</h3>
                                <p id="timer" class="text-xl sm:text-2xl font-bold text-indigo-400 l10-timer">00:00</p>
                            </div>
                            <div class="space-y-4 text-sm sm:text-base">${step.content()}</div>
                            <div class="flex justify-between">
                                <button id="prev-step" class="px-4 py-2 rounded-lg font-semibold bg-gray-800 text-gray-300 hover:bg-gray-700 disabled:opacity-40 disabled:hover:bg-gray-800" ${currentStep === 0 ? 'disabled' : ''}>Previous</button>
                                <button id="next-step" class="px-4 py-2 rounded-lg font-semibold bg-indigo-600 text-white hover:bg-indigo-500">${currentStep === steps.length - 1 ? 'Finish Meeting' : 'Next'}</button>
                            </div>
                        </div>`;
                    startTimer(step.duration);
                };

                const showLiveMeeting = () => {
                    liveTab.classList.add('border-indigo-500', 'text-indigo-400');
                    liveTab.classList.remove('text-gray-500');
                    historyTab.classList.remove('border-indigo-500', 'text-indigo-400');
                    historyTab.classList.add('text-gray-500');
                    renderL10Step();
                };

                const showHistory = () => {
                    historyTab.classList.add('border-indigo-500', 'text-indigo-400');
                    historyTab.classList.remove('text-gray-500');
                    liveTab.classList.remove('border-indigo-500', 'text-indigo-400');
                    liveTab.classList.add('text-gray-500');
                    const historyMarkup = App.data.meetingHistory.map(meeting => `<li class="p-3 border border-gray-800 bg-gray-900/70 rounded-lg flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-100">L10 Meeting - ${meeting.date}</p>
                                <p class="text-xs text-gray-400">Rating: ${meeting.rating}/10 &amp;bull; Key Topics: ${meeting.keyTopics.join(', ')}</p>
                            </div>
                            ${meeting.link ? `<a href="${meeting.link}" class="text-indigo-300 hover:underline text-xs">View</a>` : ''}
                        </li>`).join('') || '<li class="text-gray-500">No meeting history recorded.</li>';

                    contentContainer.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">Meeting History</h3>
                            <ul class="space-y-3">${historyMarkup}</ul>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">AI Sentiment Analysis</h3>
                            <p class="text-sm text-gray-400 mb-4">Sentiment scores based on the last several meetings.</p>
                            <canvas id="sentimentChart"></canvas>
                        </div>
                    </div>`;

                    const chartEl = document.getElementById('sentimentChart');
                    if (chartEl && App.data.meetingHistory.length) {
                        new Chart(chartEl, {
                            type: 'line',
                            data: {
                                labels: App.data.meetingHistory.map(m => m.date).reverse(),
                                datasets: [{
                                    label: 'Meeting Sentiment Score',
                                    data: App.data.meetingHistory.map(m => m.sentiment).reverse(),
                                    borderColor: '#6366F1',
                                    backgroundColor: 'rgba(99, 102, 241, 0.15)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 3
                                }]
                            },
                            options: {
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(148, 163, 184, 0.15)' } },
                                    y: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(148, 163, 184, 0.15)' }, suggestedMin: 0, suggestedMax: 100 }
                                }
                            }
                        });
                    }
                };

                liveTab.addEventListener('click', () => { currentStep = 0; showLiveMeeting(); });
                historyTab.addEventListener('click', showHistory);

                contentContainer.addEventListener('click', (event) => {
                    const target = event.target;
                    if (target.id === 'start-l10' || target.id === 'next-step') {
                        if (currentStep < steps.length - 1) {
                            currentStep += 1;
                            renderL10Step();
                        } else {
                            alert('Meeting finished! Great work.');
                        }
                    }
                    if (target.id === 'prev-step') {
                        if (currentStep > 0) {
                            currentStep -= 1;
                            renderL10Step();
                        }
                    }
                    if (target.classList.contains('add-to-ids-btn')) {
                        addIssue(target.dataset.issueTitle, 1);
                    }
                    if (target.classList.contains('add-headline-btn')) {
                        const sourceId = target.dataset.source;
                        const textarea = document.getElementById(sourceId);
                        if (textarea && textarea.value.trim()) {
                            addIssue(textarea.value.trim());
                            textarea.value = '';
                        }
                    }
                    if (target.id === 'add-manual-issue-btn') {
                        const input = document.getElementById('manual-issue-input');
                        if (input && input.value.trim()) {
                            addIssue(input.value.trim(), 3);
                            input.value = '';
                        }
                    }
                    if (target.classList.contains('add-todo-from-ids-btn')) {
                        const task = prompt('Enter To-Do task:', target.dataset.issueTitle || '');
                        const assignee = task ? prompt('Assign to:', 'Asfand Y.') : null;
                        if (task && assignee) addToDo(task, assignee);
                    }
                    if (target.classList.contains('delete-todo-btn')) {
                        const todoId = parseInt(target.dataset.todoId, 10);
                        App.data.l10Data.currentToDos = App.data.l10Data.currentToDos.filter(todo => todo.id !== todoId);
                        Persistence.save(App.data);
                        renderL10Step();
                    }
                });

                contentContainer.addEventListener('change', (event) => {
                    const target = event.target;
                    if (target.classList.contains('toggle-checkbox')) {
                        const rockId = parseInt(target.dataset.rockId, 10);
                        const rock = App.data.companyRocks.find(item => item.id === rockId);
                        if (rock) {
                            rock.status = target.checked ? 'On Track' : 'Off Track';
                            Persistence.save(App.data);
                            renderL10Step();
                        }
                    }
                    if (target.matches('input[type="checkbox"][data-todo-id]')) {
                        const todoId = parseInt(target.dataset.todoId, 10);
                        const todo = App.data.l10Data.lastWeeksToDos.find(item => item.id === todoId);
                        if (todo) {
                            todo.completed = target.checked;
                            Persistence.save(App.data);
                            target.closest('div.flex').style.opacity = '0';
                            setTimeout(() => renderL10Step(), 300);
                        }
                    }
                });

                contentContainer.addEventListener('input', (event) => {
                    const target = event.target;
                    if (target.matches('input[data-metric-index]')) {
                        const index = parseInt(target.dataset.metricIndex, 10);
                        if (App.data.scorecard[index]) {
                            App.data.scorecard[index].value = target.value;
                            Persistence.save(App.data);
                        }
                    }
                });

                showLiveMeeting();
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>