```
=== SOURCE_HTML ===
```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuma EOS Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background from React version */
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #menu-button {
            transition: left 0.3s ease-in-out;
        }
        #menu-button-icon {
            transition: transform 0.3s ease-in-out;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        .stat-card-icon {
            width: 3rem;
            height: 3rem;
        }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-panel {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-20 hidden md:hidden"></div>

    <div class="relative min-h-screen md:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-gray-950 text-gray-300 w-64 space-y-6 py-7 px-2 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 sidebar z-30 border-r border-gray-800">
            <a href="#" class="text-white flex items-center space-x-3 px-4">
                <svg class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                <span class="text-2xl font-extrabold">Zuma EOS</span>
            </a>

            <nav id="sidebar-nav" class="space-y-2">
                <!-- Nav links will be generated by JS -->
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <button id="menu-button" class="fixed top-1/2 -translate-y-1/2 left-0 z-40 bg-indigo-600 text-white w-8 h-16 flex items-center justify-center rounded-r-lg focus:outline-none shadow-lg md:hidden">
                 <svg id="menu-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="m9 18 6-6-6-6"/></svg>
            </button>
            <header class="flex justify-between items-center p-4 bg-gray-900 border-b border-gray-800">
                <div class="flex items-center space-x-4">
                    <button id="refresh-btn" onclick="App.manualRefresh()" class="text-gray-400 hover:text-white transition-colors" title="Manual Refresh">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                    </button>
                    <div class="text-xs text-gray-500">
                        <span class="flex items-center">
                            <svg class="w-3 h-3 mr-1 text-green-400 animate-pulse" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>
                            Live Updates Active
                        </span>
                        <span id="last-update" class="text-gray-600">Last: Just now</span>
                    </div>
                </div>
                 <div class="flex items-center space-x-4">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                     <div class="flex items-center">
                         <img src="https://placehold.co/40x40/818CF8/111827?text=AY" alt="User Avatar" class="w-10 h-10 rounded-full">
                         <div class="ml-3">
                             <p class="text-sm font-semibold text-gray-100">Asfand Yaar</p>
                             <p class="text-xs text-gray-400">Visionary / Integrator</p>
                         </div>
                    </div>
                 </div>
            </header>
            
            <div id="main-scroll-area" class="flex-1 p-4 sm:p-6 overflow-y-auto">
                 <h1 id="page-title" class="text-3xl font-bold text-white mb-6">Dashboard</h1>
                 <main id="main-app">
                    <!-- Page content will be injected here -->
                 </main>
            </div>
        </div>
    </div>

    <!-- Rock Modal -->
    <div id="rock-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <h3 id="rock-modal-title" class="text-xl font-bold text-white">Add Rock</h3>
            </div>
            <form id="rock-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Rock Name *</label>
                    <input type="text" name="rock-name" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Type *</label>
                    <select name="rock-type" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                        <option value="company">Company</option>
                        <option value="department">Department</option>
                        <option value="individual">Individual</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Owner</label>
                    <input type="text" name="rock-owner" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Department</label>
                    <select name="rock-department" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                        <option value="">Select Department</option>
                        <option value="engineering">Engineering</option>
                        <option value="marketing">Marketing</option>
                        <option value="sales">Sales</option>
                        <option value="product">Product</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                    <select name="rock-status" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                        <option value="On Track">On Track</option>
                        <option value="Off Track">Off Track</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Due Date</label>
                    <input type="date" name="rock-due" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Notes</label>
                    <textarea name="rock-notes" rows="3" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none"></textarea>
                </div>
            </form>
            <div class="p-6 border-t border-gray-700 flex justify-between">
                <button id="delete-rock-btn" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500">Delete</button>
                <div class="ml-auto space-x-3">
                    <button id="cancel-rock-btn" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                    <button id="save-rock-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Metric Modal -->
    <div id="metric-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg max-w-md w-full">
            <div class="p-6 border-b border-gray-700">
                <h3 id="metric-modal-title" class="text-xl font-bold text-white">Add Metric</h3>
            </div>
            <form id="metric-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Metric Name *</label>
                    <input type="text" name="metric-name" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Goal</label>
                    <input type="text" name="metric-goal" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none" placeholder="e.g., 95%, $100k, <2hrs">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Current Value</label>
                    <input type="text" name="metric-value" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Type</label>
                    <select name="metric-type" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                        <option value="company">Company Scorecard</option>
                        <option value="department">Department Scorecard</option>
                    </select>
                </div>
                <div id="metric-department-select" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Department</label>
                    <select name="metric-department" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                        <option value="">Select Department</option>
                        <option value="engineering">Engineering</option>
                        <option value="marketing">Marketing</option>
                        <option value="sales">Sales</option>
                        <option value="product">Product</option>
                    </select>
                </div>
            </form>
            <div class="p-6 border-t border-gray-700 flex justify-between">
                <button id="delete-metric-btn" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500">Delete</button>
                <div class="ml-auto space-x-3">
                    <button id="cancel-metric-btn" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                    <button id="save-metric-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Bot -->
    <div id="ai-chat-button" class="fixed bottom-6 right-6 z-40">
        <button id="open-ai-chat" class="bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-full shadow-lg flex items-center space-x-2">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
            </svg>
            <span class="hidden lg:inline">Zuma Assistant</span>
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
        </button>
    </div>

    <!-- AI Chat Modal -->
    <div id="ai-chat-modal" class="hidden fixed bottom-24 right-6 w-[520px] h-[600px] bg-gray-850 rounded-lg shadow-2xl border border-gray-700 z-50 flex flex-col" style="background: linear-gradient(to bottom, #1a1f2e, #111827);">
        <div class="p-4 border-b border-gray-700 bg-gray-900/50 rounded-t-lg flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                <h3 class="font-bold text-white">Zuma Assistant</h3>
            </div>
            <button id="close-ai-chat" class="text-gray-400 hover:text-white">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>

        <div id="ai-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
            <style>
                #ai-chat-messages::-webkit-scrollbar {
                    width: 6px;
                }
                #ai-chat-messages::-webkit-scrollbar-track {
                    background: #1f2937;
                    border-radius: 3px;
                }
                #ai-chat-messages::-webkit-scrollbar-thumb {
                    background: #4b5563;
                    border-radius: 3px;
                }
                #ai-chat-messages::-webkit-scrollbar-thumb:hover {
                    background: #6b7280;
                }
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                .chat-message {
                    animation: slideUp 0.3s ease-out;
                }
                .ai-message-content p {
                    margin-bottom: 0.75rem;
                }
                .ai-message-content ul {
                    list-style: disc;
                    margin-left: 1.25rem;
                    margin-bottom: 0.75rem;
                }
                .ai-message-content li {
                    margin-bottom: 0.25rem;
                }
                .ai-message-content strong {
                    font-weight: 600;
                    color: #e5e7eb;
                }
            </style>
            <div class="flex items-start space-x-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path>
                    </svg>
                </div>
                <div class="flex-1 bg-gray-800 rounded-lg p-3 border border-gray-700">
                    <p class="text-sm text-gray-300">Hi Asfand! I'm your Zuma Assistant. I can help you analyze meetings, track rocks, and provide insights. How can I help you today?</p>
                </div>
            </div>
        </div>

        <div class="border-t border-gray-700 p-4 bg-gray-900/30">
            <div class="flex gap-2 mb-3">
                <button class="ai-quick-action flex-1 text-xs font-medium bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-300 px-2 py-2 rounded-lg transition-colors flex items-center justify-center gap-1 whitespace-nowrap" data-action="analyze-meeting">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 100 4h2a2 2 0 100-4h2a1 1 0 100-2 2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6z" clip-rule="evenodd"></path></svg>
                    <span>Analyze Meeting</span>
                </button>
                <button class="ai-quick-action flex-1 text-xs font-medium bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-300 px-2 py-2 rounded-lg transition-colors flex items-center justify-center gap-1 whitespace-nowrap" data-action="off-track">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    <span>Off-Track</span>
                </button>
                <button class="ai-quick-action flex-1 text-xs font-medium bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-300 px-2 py-2 rounded-lg transition-colors flex items-center justify-center gap-1 whitespace-nowrap" data-action="weekly-report">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
                    <span>Weekly Report</span>
                </button>
            </div>
            <div class="flex space-x-2">
                <input id="ai-chat-input" type="text" class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-indigo-500 focus:outline-none placeholder-gray-500" placeholder="Ask me anything...">
                <button id="ai-send-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employee-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg max-w-md w-full">
            <div class="p-6 border-b border-gray-700">
                <h3 id="employee-modal-title" class="text-xl font-bold text-white">Add Employee</h3>
            </div>
            <form id="employee-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Name *</label>
                    <input type="text" name="employee-name" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Role</label>
                    <input type="text" name="employee-role" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Department</label>
                    <select name="employee-department" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                        <option value="">Select Department</option>
                        <option value="engineering">Engineering</option>
                        <option value="marketing">Marketing</option>
                        <option value="sales">Sales</option>
                        <option value="product">Product</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" name="employee-email" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-indigo-500 focus:outline-none">
                </div>
            </form>
            <div class="p-6 border-t border-gray-700 flex justify-between">
                <button id="delete-employee-btn" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500">Delete</button>
                <div class="ml-auto space-x-3">
                    <button id="cancel-employee-btn" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                    <button id="save-employee-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UTILITIES & HELPERS ---
        const Security = {
            escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            sanitizeInput(str) {
                return str?.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                    .replace(/on\w+\s*=/gi, '')
                    .trim() || '';
            }
        };

        const UI = {
            showLoading(message = 'Loading...') {
                const loader = document.createElement('div');
                loader.id = 'loading-indicator';
                loader.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                loader.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
                        <span>${Security.escapeHtml(message)}</span>
                    </div>
                `;
                document.body.appendChild(loader);
            },
            hideLoading() {
                const loader = document.getElementById('loading-indicator');
                if (loader) loader.remove();
            },
            showModal({ title, contentHTML, onSubmit, submitText = 'Submit' }) {
                const modalContainer = document.getElementById('modal-container');
                const modalHTML = `
                    <div id="modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 opacity-0">
                        <div id="modal-panel" class="modal-panel bg-gray-900 border border-gray-700 rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95 opacity-0">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white">${title}</h2>
                                <button id="modal-close" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
                            </div>
                            <div id="modal-content">${contentHTML}</div>
                            <div class="flex justify-end mt-6 space-x-4">
                                <button id="modal-cancel" class="bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600">Cancel</button>
                                <button id="modal-submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700">${submitText}</button>
                            </div>
                        </div>
                    </div>`;
                modalContainer.innerHTML = modalHTML;
                
                const overlay = document.getElementById('modal-overlay');
                const panel = document.getElementById('modal-panel');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    panel.classList.remove('scale-95', 'opacity-0');
                }, 10);

                document.getElementById('modal-close').onclick = () => UI.hideModal();
                document.getElementById('modal-cancel').onclick = () => UI.hideModal();
                overlay.onclick = (e) => { if (e.target === overlay) UI.hideModal(); };
                if (onSubmit) {
                    document.getElementById('modal-submit').onclick = () => {
                        const contentDiv = document.getElementById('modal-content');
                        onSubmit(contentDiv);
                    };
                }
            },
            hideModal() {
                const overlay = document.getElementById('modal-overlay');
                const panel = document.getElementById('modal-panel');
                if (!overlay || !panel) return;

                overlay.classList.add('opacity-0');
                panel.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            }
        };

        const Icons = {
            home: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            vision: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            departments: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>`,
            people: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            data: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>`,
            issues: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`,
            rocks: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.48 3.48a2 2 0 0 1 2.04 0l6 3.5A2 2 0 0 1 21 8.66v6.68a2 2 0 0 1-1.48 1.93l-6 3.5a2 2 0 0 1-2.04 0l-6-3.5A2 2 0 0 1 3 15.34V8.66a2 2 0 0 1 1.48-1.93l6-3.5Z"/><path d="m3.5 8.5 8.5 5 8.5-5"/><path d="M12 22V13.5"/></svg>`,
            meetings: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v5Z"/><path d="M18 9h2a2 2 0 0 1 2 2v11l-4-4h-6a2 2 0 0 1-2-2v-1"/></svg>`,
            integrations: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>`,
            ai: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>`,
            plus: () => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
            trash: () => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
        };

        const Persistence = {
            KEY: 'zuma_eos_state_v3',
            load() {
                try {
                    const storedState = localStorage.getItem(this.KEY);
                    if (storedState) return JSON.parse(storedState);
                    return null;
                } catch (e) {
                    console.error("Failed to load state from localStorage", e);
                    return null;
                }
            },
            save(state) {
                try {
                    localStorage.setItem(this.KEY, JSON.stringify(state));
                } catch (e) {
                    console.error("Failed to save state to localStorage", e);
                }
            }
        };

        const AI = {
            analyze(data) {
                // Analyze scorecard performance
                const scorecardAnalysis = [];
                if (data.scorecard) {
                    data.scorecard.forEach(item => {
                        const goal = parseFloat(String(item.goal).replace(/[^0-9.-]/g, '')) || 0;
                        const value = parseFloat(String(item.value).replace(/[^0-9.-]/g, '')) || 0;
                        const isTimeMetric = item.metric.toLowerCase().includes('time');
                        const onTarget = isTimeMetric ? value <= goal : value >= goal;

                        if (onTarget && Math.abs((value - goal) / goal) > 0.1) {
                            scorecardAnalysis.push({ metric: item.metric, status: 'exceeding' });
                        } else if (!onTarget) {
                            scorecardAnalysis.push({ metric: item.metric, status: 'below' });
                        }
                    });
                }

                // Analyze rocks
                const companyRocks = data.companyRocks || [];
                const deptRocks = Object.values(data.departmentalRocks || data.departmentRocks || {}).flat();
                const allRocks = [...companyRocks, ...deptRocks];
                const offTrackRocks = allRocks.filter(r => r.status === 'Off Track');
                const onTrackRocks = allRocks.filter(r => r.status === 'On Track');

                // Build analysis HTML
                let html = '<p class="text-indigo-200 mb-3">Good morning, Asfand. Here\'s a summary of Zuma\'s current status:</p>';
                html += '<ul class="list-disc list-inside mt-2 text-sm space-y-2">';

                // Key Wins
                const wins = [];
                if (scorecardAnalysis.filter(s => s.status === 'exceeding').length > 0) {
                    wins.push(scorecardAnalysis.filter(s => s.status === 'exceeding').map(s => s.metric).join(', ') + ' are above goal');
                }
                if (onTrackRocks.length > offTrackRocks.length) {
                    wins.push(`${Math.round((onTrackRocks.length / allRocks.length) * 100)}% of rocks are on track`);
                }
                if (wins.length > 0) {
                    html += `<li><strong class="font-semibold text-green-300">Key Wins:</strong> ${wins.join('. ')}.</li>`;
                }

                // Risks to Watch
                const risks = [];
                if (offTrackRocks.length > 0) {
                    risks.push(`${offTrackRocks.length} rock${offTrackRocks.length > 1 ? 's are' : ' is'} off track${offTrackRocks[0] ? ' including "' + (offTrackRocks[0].title || offTrackRocks[0].name) + '"' : ''}`);
                }
                if (scorecardAnalysis.filter(s => s.status === 'below').length > 0) {
                    const belowMetrics = scorecardAnalysis.filter(s => s.status === 'below').map(s => s.metric);
                    risks.push(`${belowMetrics.slice(0, 2).join(' and ')} ${belowMetrics.length === 1 ? 'is' : 'are'} below target`);
                }
                if (risks.length > 0) {
                    html += `<li><strong class="font-semibold text-yellow-300">Risks to Watch:</strong> ${risks.join('. ')}.</li>`;
                }

                // Suggested L10 Focus
                const suggestions = [];
                if (offTrackRocks.length > 0) {
                    suggestions.push('prioritize discussing off-track rocks');
                }
                if (data.issues && data.issues.filter(i => i.priority === 1).length > 0) {
                    suggestions.push('address critical priority issues');
                }
                if (suggestions.length > 0) {
                    html += `<li><strong class="font-semibold text-blue-300">Suggested L10 Focus:</strong> ${suggestions.join(' and ')} to get back on track.</li>`;
                } else {
                    html += `<li><strong class="font-semibold text-blue-300">Suggested L10 Focus:</strong> Continue momentum on current initiatives and review quarterly rock progress.</li>`;
                }

                html += '</ul>';
                return html;
            }
        };

        const App = {
            data: {},
            lastUpdateTime: new Date(),
            autoRefreshInterval: null,
            webhookSimulationInterval: null,
            _charts: [], // Track chart instances
            currentL10Department: null, // Track L10 meeting department

            getWeekId(date = new Date()) {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
                return `${d.getUTCFullYear()}-${String(weekNo).padStart(2, '0')}`;
            },

            simulateWebhookUpdate() {
                const changes = ['scorecard', 'rocks', 'issues'];
                const change = changes[Math.floor(Math.random() * changes.length)];

                if (change === 'scorecard' && this.data.scorecard.length > 0) {
                    const idx = Math.floor(Math.random() * this.data.scorecard.length);
                    const oldValue = parseFloat(this.data.scorecard[idx].value) || 0;
                    const variation = (Math.random() - 0.5) * 10;
                    this.data.scorecard[idx].value = Math.round(oldValue + variation).toString();
                }

                this.lastUpdateTime = new Date();
                this.updateTimestamp();
                Persistence.save(this.data);
                this.showUpdateNotification(change);

                if (window.location.hash === '#dashboard' || window.location.hash === '') {
                    this.render('dashboard');
                }
            },

            updateTimestamp() {
                const el = document.getElementById('last-update');
                if (el) {
                    const now = new Date();
                    const diff = Math.floor((now - this.lastUpdateTime) / 1000);
                    let text = 'Just now';
                    if (diff > 60) text = `${Math.floor(diff / 60)}m ago`;
                    if (diff > 3600) text = `${Math.floor(diff / 3600)}h ago`;
                    el.textContent = `Last: ${text}`;
                }
            },

            showUpdateNotification(type) {
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-20 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-40 animate-pulse transition-opacity duration-500';
                notification.innerHTML = `<span class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Live update: ${type} data refreshed</span>`;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 500);
                }, 2500);
            },

            startAutoRefresh() {
                this.autoRefreshInterval = setInterval(() => {
                    this.simulateWebhookUpdate();
                }, 15 * 60 * 1000);

                this.webhookSimulationInterval = setInterval(() => {
                    if (Math.random() > 0.7) {
                        this.simulateWebhookUpdate();
                    }
                }, 30000);
            },

            manualRefresh() {
                this.simulateWebhookUpdate();
                this.updateTimestamp();
                const btn = document.getElementById('refresh-btn');
                if (btn) {
                    btn.classList.add('animate-spin');
                    setTimeout(() => btn.classList.remove('animate-spin'), 1000);
                }
            },

            init() {
                const loadedState = Persistence.load();
                if (loadedState) {
                    this.data = loadedState;
                } else {
                    this.data = {
                        companyName: "Zuma",
                        employees: [
                            { id: 'emp1', name: 'Asfand Yaar', role: 'Visionary/Integrator', department: 'leadership' },
                            { id: 'emp2', name: 'Gocha Avsajanishvili', role: 'Tech Lead', department: 'technology' },
                            { id: 'emp3', name: 'Prince Ezra', role: 'Senior Developer', department: 'technology' },
                            { id: 'emp4', name: 'Akash', role: 'Developer', department: 'technology' },
                            { id: 'emp5', name: 'Saeed Ahmed', role: 'Developer', department: 'technology' },
                            { id: 'emp6', name: 'JC Vergara', role: 'QA Engineer', department: 'technology' },
                            { id: 'emp7', name: 'Hamza Khan', role: 'Marketing Head', department: 'marketing' },
                            { id: 'emp8', name: 'Sarah Chen', role: 'UX Designer', department: 'marketing' },
                            { id: 'emp9', name: 'Mike Johnson', role: 'SEO Writer', department: 'marketing' },
                            { id: 'emp10', name: 'Lisa Park', role: 'Ads Specialist', department: 'marketing' },
                            { id: 'emp11', name: 'John Smith', role: 'Sales Lead', department: 'operations' },
                            { id: 'emp12', name: 'Maria Garcia', role: 'Repair Manager', department: 'operations' },
                            { id: 'emp13', name: 'Tom Wilson', role: 'Shipping Coordinator', department: 'operations' }
                        ],
                        vto: {
                            coreValues: ["Customer First", "Innovate & Simplify", "Own It", "Get It Done Right", "Team Player"],
                            coreFocus: { purpose: "To be the most trusted and efficient online source for aerial lift equipment and parts.", niche: "Providing high-quality used aerial lifts and parts with exceptional digital experience." },
                            tenYearTarget: "To be the #1 online destination for aerial lifts in North America.",
                            marketingStrategy: { targetMarket: "Construction companies, equipment rental businesses, and maintenance contractors in North America.", threeUniques: ["Unified Listing Platform for maximum reach", "In-house tech for superior customer experience (TIP)", "Deep industry expertise and transparent inspections."], provenProcess: "Source -> Inspect (TIP) -> Repair -> List (ULP) -> Sell -> Ship -> Support.", guarantee: "30-day parts warranty on all repaired machines." },
                            threeYearPicture: "Achieve $50M in annual revenue. ULP lists on 10+ platforms. TIP is used by 5 external partners.",
                            oneYearPlan: ["Launch zumasales.com v3 on Shopify Plus.", "Integrate Odoo with ULP for real-time inventory.", "Reduce average repair time by 15% using TIP data.", "Increase organic traffic to zuma.ca by 40%."]
                        },
                        scorecard: [
                            { metric: "Shopify Sales ($)", goal: "150000", value: "165000", trend: },
                            { metric: "ULP Listings Created", goal: "50", value: "45", trend: },
                            { metric: "Machines Inspected (TIP)", goal: "25", value: "28", trend: },
                            { metric: "Website Leads (zuma.ca)", goal: "100", value: "110", trend: },
                            { metric: "Customer Satisfaction (CSAT %)", goal: "95", value: "96", trend: },
                            { metric: "Invoice Processing Time (hrs)", goal: "2", value: "1.5", trend: [2.5, 2.1, 1.8, 1.5] },
                        ],
                        departmentalScorecards: {
                            technology: [
                                { metric: "ULP Uptime %", goal: "99.9", value: "99.95", trend: [99.8, 99.9, 99.92, 99.95] },
                                { metric: "Avg Page Load (s)", goal: "1.5", value: "1.2", trend: [1.6, 1.4, 1.3, 1.2] },
                                { metric: "Bugs Closed Weekly", goal: "15", value: "18", trend: },
                                { metric: "Code Coverage %", goal: "80", value: "82", trend: }
                            ],
                            marketing: [
                                { metric: "Organic Traffic (k/wk)", goal: "10", value: "11.2", trend: [9.5, 10.2, 10.8, 11.2] },
                                { metric: "Cost Per Lead ($)", goal: "50", value: "45.50", trend: [52, 48, 46, 45.5] },
                                { metric: "Keyword Rankings Top 3", goal: "20", value: "18", trend: },
                                { metric: "Social Engagement %", goal: "5", value: "5.8", trend: [4.5, 5.0, 5.5, 5.8] }
                            ],
                            operations: [
                                { metric: "Avg Repair Time (days)", goal: "5", value: "6.1", trend: [7, 6.5, 6.3, 6.1] },
                                { metric: "Machines Shipped Weekly", goal: "10", value: "12", trend: },
                                { metric: "Sales Qualified Leads", goal: "30", value: "35", trend: },
                                { metric: "Order Fulfillment %", goal: "95", value: "94", trend: }
                            ]
                        },
                        scorecardHistory: {},
                        companyRocks: [
                            { id: 1, title: "ULP Craigslist Integration", owner: "Asfand Yaar", ownerId: "emp1", status: "On Track", team: "Dev", quarter: "Q4 2025" },
                            { id: 2, title: "Q4 SEO Strategy for zuma.ca", owner: "Hamza Khan", ownerId: "emp7", status: "On Track", team: "Marketing", quarter: "Q4 2025" },
                            { id: 3, title: "Streamline Shopify-Odoo Order Sync", owner: "Gocha Avsajanishvili", ownerId: "emp2", status: "Off Track", team: "Dev", quarter: "Q4 2025" },
                            { id: 4, title: "Implement new TIP inspection template", owner: "Asfand Yaar", ownerId: "emp1", status: "Done", team: "Ops", quarter: "Q4 2025" },
                        ],
                        departmentRocks: {
                            technology: [
                                { id: 101, title: "Launch ULP v2 beta", owner: "Gocha A.", ownerId: "emp2", status: "On Track", department: "technology" },
                                { id: 102, title: "Implement CI/CD pipeline", owner: "Prince E.", ownerId: "emp3", status: "On Track", department: "technology" }
                            ],
                            marketing: [
                                { id: 201, title: "Launch influencer program", owner: "Hamza K.", ownerId: "emp7", status: "On Track", department: "marketing" },
                                { id: 202, title: "Redesign email campaigns", owner: "Sarah C.", ownerId: "emp8", status: "Done", department: "marketing" }
                            ],
                            operations: [
                                { id: 301, title: "Reduce repair time 20%", owner: "Maria G.", ownerId: "emp12", status: "Off Track", department: "operations" },
                                { id: 302, title: "New shipping partners", owner: "Tom W.", ownerId: "emp13", status: "On Track", department: "operations" }
                            ]
                        },
                        individualRocks: [
                            { id: 1001, title: "Complete AWS certification", employeeId: "emp3", employeeName: "Prince Ezra", department: "technology", status: "On Track" },
                            { id: 1002, title: "Refactor TIP image upload", employeeId: "emp3", employeeName: "Prince Ezra", department: "technology", status: "Done" },
                            { id: 1003, title: "Automate QA tests", employeeId: "emp6", employeeName: "JC Vergara", department: "technology", status: "On Track" },
                            { id: 1004, title: "Build Shopify integration", employeeId: "emp4", employeeName: "Akash", department: "technology", status: "On Track" },
                            { id: 1005, title: "Create 10 SEO blog posts", employeeId: "emp9", employeeName: "Mike Johnson", department: "marketing", status: "Off Track" },
                            { id: 1006, title: "Design landing pages", employeeId: "emp8", employeeName: "Sarah Chen", department: "marketing", status: "Done" },
                            { id: 1007, title: "Optimize Google Ads", employeeId: "emp10", employeeName: "Lisa Park", department: "marketing", status: "On Track" },
                            { id: 1008, title: "Close 5 enterprise deals", employeeId: "emp11", employeeName: "John Smith", department: "operations", status: "On Track" },
                            { id: 1009, title: "Implement lean process", employeeId: "emp12", employeeName: "Maria Garcia", department: "operations", status: "Off Track" },
                            { id: 1010, title: "Setup intl shipping", employeeId: "emp13", employeeName: "Tom Wilson", department: "operations", status: "On Track" }
                        ],
                        issues: [
                            { id: 1, title: "Odoo sync with Shopify is lagging by 30 mins", priority: 1, age: 5, department: "technology" },
                            { id: 2, title: "Need to define Q4 marketing budget for new ad campaigns", priority: 2, age: 12, department: "marketing" },
                            { id: 3, title: "High volume of support tickets for checkout", priority: 1, age: 2, department: "technology" },
                            { id: 4, title: "Recruitment plan for Senior SEO Writer", priority: 3, age: 20, department: "marketing" },
                            { id: 5, title: "Inconsistent photo quality from TIP", priority: 2, age: 8, department: "operations" },
                            { id: 6, title: "Shortage of hydraulic pumps", priority: 1, age: 3, department: "operations" }
                        ],
                        todos: [
                            { id: 501, task: "Review Q3 Marketing Graphics", assignee: "Hamza K.", assigneeId: "emp7", department: "marketing", dueDate: "2025-09-30", completed: false },
                            { id: 502, task: "Finalize server spec for ULP v2", assignee: "Gocha A.", assigneeId: "emp2", department: "technology", dueDate: "2025-09-28", completed: false },
                            { id: 503, task: "Contact new parts supplier", assignee: "Maria G.", assigneeId: "emp12", department: "operations", dueDate: "2025-09-29", completed: true },
                            { id: 504, task: "Fix login bug on mobile", assignee: "Prince E.", assigneeId: "emp3", department: "technology", dueDate: "2025-09-27", completed: true }
                        ],
                        meetingHistory: [
                            { id: "mtg1", date: "Sep 22, 2025", department: "technology", rating: 9, sentiment: 85, keyTopics: ["Shopify Sync", "API Performance"], completedTodos:, message: "Tech team will provide update on sync fix.", transcriptionUrl: "https://meet.google.com/recordings/tech-092225", notes: "Discussed Odoo sync. Prince fixed mobile login. Team morale high." },
                            { id: "mtg2", date: "Sep 22, 2025", department: "marketing", rating: 8, sentiment: 82, keyTopics: ["SEO Strategy", "Ad Campaigns"], completedTodos: [], message: "Marketing to finalize Q4 budget.", transcriptionUrl: "https://meet.google.com/recordings/mkt-092225", notes: "Reviewed SEO. Lisa's ads showing 15% better CTR." },
                            { id: "mtg3", date: "Sep 22, 2025", department: "operations", rating: 7, sentiment: 75, keyTopics: ["Repair Times", "Parts"], completedTodos:, message: "Maria contacted supplier.", transcriptionUrl: "https://meet.google.com/recordings/ops-092225", notes: "Pump shortage critical. Repair times above target." },
                            { id: "mtg4", date: "Sep 15, 2025", department: "technology", rating: 8, sentiment: 88, keyTopics: ["ULP v2", "Testing"], completedTodos: [], message: "JC to complete test automation.", transcriptionUrl: "https://meet.google.com/recordings/tech-091525", notes: "ULP v2 on track." },
                            { id: "mtg5", date: "Sep 15, 2025", department: "marketing", rating: 9, sentiment: 90, keyTopics: ["Landing Pages"], completedTodos: [], message: "Sarah's designs approved.", transcriptionUrl: "https://meet.google.com/recordings/mkt-091525", notes: "25% better conversion in A/B tests." }
                        ],
                        departments: {
                            technology: {
                                name: "Technology",
                                head: "Asfand Yaar",
                                headId: "emp1",
                                members: ["Gocha Avsajanishvili", "Prince Ezra", "Akash", "Saeed Ahmed", "JC Vergara"],
                                memberIds: ["emp2", "emp3", "emp4", "emp5", "emp6"],
                                rocks: 2,
                                issues: 2
                            },
                            marketing: {
                                name: "Marketing",
                                head: "Hamza Khan",
                                headId: "emp7",
                                members: ["Sarah Chen", "Mike Johnson", "Lisa Park"],
                                memberIds: ["emp8", "emp9", "emp10"],
                                rocks: 2,
                                issues: 2
                            },
                            operations: {
                                name: "Operations",
                                head: "Asfand Yaar (Interim)",
                                headId: "emp1",
                                members: ["John Smith", "Maria Garcia", "Tom Wilson"],
                                memberIds: ["emp11", "emp12", "emp13"],
                                rocks: 2,
                                issues: 2
                            },
                            sales: {
                                name: "Sales",
                                head: "Michael Roberts",
                                headId: "emp14",
                                members: ["Emma Thompson", "Daniel Lee", "Sophie Anderson"],
                                memberIds: ["emp15", "emp16", "emp17"],
                                rocks: 3,
                                issues: 2
                            },
                            finance: {
                                name: "Finance",
                                head: "Jennifer Wu",
                                headId: "emp18",
                                members: ["Robert Chang", "Alice Morgan"],
                                memberIds: ["emp19", "emp20"],
                                rocks: 1,
                                issues: 0
                            },
                            hr: {
                                name: "Human Resources",
                                head: "Patricia Davis",
                                headId: "emp21",
                                members: ["Kevin Brown", "Nancy White"],
                                memberIds: ["emp22", "emp23"],
                                rocks: 2,
                                issues: 1
                            },
                            product: {
                                name: "Product",
                                head: "Alex Turner",
                                headId: "emp24",
                                members: ["Chris Martinez", "Rachel Green", "Sam Taylor"],
                                memberIds: ["emp25", "emp26", "emp27"],
                                rocks: 4,
                                issues: 3
                            },
                            customerSuccess: {
                                name: "Customer Success",
                                head: "Linda Jackson",
                                headId: "emp28",
                                members: ["Brian Wilson", "Diana Ross"],
                                memberIds: ["emp29", "emp30"],
                                rocks: 2,
                                issues: 1
                            },
                            legal: {
                                name: "Legal & Compliance",
                                head: "David Miller",
                                headId: "emp31",
                                members: ["Jessica Brown"],
                                memberIds: ["emp32"],
                                rocks: 1,
                                issues: 0
                            },
                            businessDev: {
                                name: "Business Development",
                                head: "Thomas Anderson",
                                headId: "emp33",
                                members: ["Michelle Lee", "Ryan Cooper"],
                                memberIds: ["emp34", "emp35"],
                                rocks: 3,
                                issues: 2
                            }
                        }
                    };
                    Persistence.save(this.data);
                }
                
                this.data.l10Data = {
                    lastWeeksToDos: [{ id: 1, task: "Review Q3 Marketing Graphics", assignee: "Hamza K.", completed: false }, { id: 2, task: "Finalize server spec for ULP v2", assignee: "Gocha A.", completed: false }],
                    currentToDos: [],
                    meetingIssues: JSON.parse(JSON.stringify(this.data.issues || [])),
                };

                this.startAutoRefresh();
                this.renderSidebar();
                this.router();
                window.addEventListener('hashchange', this.router.bind(this));

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + S to save
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        Persistence.save(App.data);
                        App.showNotification('success', 'All changes saved');
                    }
                    // ESC to close modals
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                            modal.classList.add('hidden');
                        });
                    }
                });

                // Auto-save indicator
                this.hasUnsavedChanges = false;
                setInterval(() => {
                    if (this.hasUnsavedChanges) {
                        Persistence.save(App.data);
                        this.hasUnsavedChanges = false;
                    }
                }, 30000);
                
                const menuButton = document.getElementById('menu-button');
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const menuIcon = document.getElementById('menu-button-icon');
                const toggleSidebar = () => {
                    const isOpen = !sidebar.classList.contains('-translate-x-full');
                    if (isOpen) {
                        sidebar.classList.add('-translate-x-full');
                        overlay.classList.add('hidden');
                        menuIcon.classList.remove('rotate-180');
                        menuButton.classList.remove('left-64'); menuButton.classList.add('left-0');
                    } else {
                        sidebar.classList.remove('-translate-x-full');
                        overlay.classList.remove('hidden');
                        menuIcon.classList.add('rotate-180');
                        menuButton.classList.remove('left-0'); menuButton.classList.add('left-64');
                    }
                };
                menuButton.addEventListener('click', toggleSidebar);
                overlay.addEventListener('click', toggleSidebar);

                // Event delegation for dynamically added elements
                document.body.addEventListener('input', (e) => {
                    if (e.target.classList.contains('scorecard-input')) {
                        const index = parseInt(e.target.dataset.index);
                        App.data.scorecard[index].value = e.target.value;
                        Persistence.save(App.data);
                    }
                    if (e.target.classList.contains('dept-scorecard-input')) {
                        const dept = e.target.dataset.dept;
                        const idx = parseInt(e.target.dataset.index);
                        if (App.data.departmentalScorecards[dept] && App.data.departmentalScorecards[dept][idx]) {
                            App.data.departmentalScorecards[dept][idx].value = e.target.value;
                            Persistence.save(App.data);
                        }
                    }
                });

                // Track if this is the first message in the session
                // Since we already have a hardcoded greeting, we set this to false
                let isFirstMessage = false;

                // AI Chat Bot handlers
                document.getElementById('open-ai-chat')?.addEventListener('click', () => {
                    document.getElementById('ai-chat-modal').classList.toggle('hidden');
                });

                document.getElementById('close-ai-chat')?.addEventListener('click', () => {
                    document.getElementById('ai-chat-modal').classList.add('hidden');
                });

                // AI Chat input enter key handler
                document.getElementById('ai-chat-input')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('ai-send-btn')?.click();
                    }
                });

                // AI Quick action buttons
                document.querySelectorAll('.ai-quick-action').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        const input = document.getElementById('ai-chat-input');

                        const queries = {
                            'analyze-meeting': 'Analyze the last L10 meeting and provide insights',
                            'off-track': 'Show me all off-track rocks and suggest actions',
                            'weekly-report': 'Generate a weekly report summary'
                        };

                        if (input && queries[action]) {
                            input.value = queries[action];
                            document.getElementById('ai-send-btn')?.click();
                        }
                    });
                });

                document.getElementById('ai-send-btn')?.addEventListener('click', async () => {
                    const input = document.getElementById('ai-chat-input');
                    const messages = document.getElementById('ai-chat-messages');
                    if (input && input.value.trim() && messages) {
                        const userQuery = input.value.trim();

                        // Add user message
                        const userMsg = document.createElement('div');
                        userMsg.className = 'flex items-start space-x-2 justify-end chat-message';
                        userMsg.innerHTML = `
                            <div class="bg-indigo-600 rounded-lg p-3 max-w-xs">
                                <p class="text-sm text-white">${Security.escapeHtml(userQuery)}</p>
                            </div>
                        `;
                        messages.appendChild(userMsg);

                        // Show typing indicator
                        const typingDiv = document.createElement('div');
                        typingDiv.className = 'flex items-start space-x-2';
                        typingDiv.innerHTML = `
                            <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 bg-gray-800 rounded-lg p-3 border border-gray-700">
                                <p class="text-sm text-gray-400 italic">Thinking...</p>
                            </div>
                        `;
                        messages.appendChild(typingDiv);
                        messages.scrollTop = messages.scrollHeight;

                        try {
                            // Call Gemini API
                            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=AIzaSyA8JC0eio8QxDLm4h-9cHNqyUFbJaAe7N0', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [{
                                            text: `You are Zuma Assistant, an AI assistant for an EOS (Entrepreneurial Operating System) business management platform. The current user is Asfand.

IMPORTANT CONTEXT - Full Company Data:
${JSON.stringify({
    company: App.data.companyName,
    employees: App.data.employees.map(e => ({name: e.name, role: e.role, department: e.department})),
    departments: Object.entries(App.data.departments).map(([key, dept]) => ({
        key,
        name: dept.name,
        head: dept.head,
        members: dept.members,
        rocks: dept.rocks,
        issues: dept.issues
    })),
    companyRocks: App.data.companyRocks,
    departmentalRocks: App.data.departmentalRocks || App.data.departmentRocks,
    individualRocks: App.data.individualRocks,
    issues: App.data.issues,
    scorecard: App.data.scorecard,
    vto: App.data.vto,
    meetingHistory: App.data.meetingHistory.slice(-5),
    todos: App.data.todos
}, null, 2)}

User question: ${userQuery}
Is this the first message in session: ${isFirstMessage}

Response Guidelines:
- NEVER start with a greeting (Hello, Hi, etc.) - the user has already been greeted in the chat welcome message
- Get straight to the point and answer the question directly
- Be direct and concise
- Know the employees by name - for example, Gocha Avsajanishvili is the Tech Lead in Technology department
- Format your response using proper HTML tags:
  * Use <p> for paragraphs
  * Use <ul> and <li> for lists
  * Use <strong> for emphasis
  * Use <br> for line breaks where appropriate
- Keep responses concise and scannable
- IMPORTANT: Do not wrap response in code blocks or backticks
- Be specific with data - you have access to all company information

Address the user as Asfand when appropriate, but not in every response.`
                                        }]
                                    }]
                                })
                            });

                            // Remove typing indicator
                            messages.removeChild(typingDiv);

                            if (response.ok) {
                                const data = await response.json();
                                const aiResponse = data.candidates.content.parts.text;

                                // Add AI response
                                const aiMsg = document.createElement('div');
                                aiMsg.className = 'flex items-start space-x-2 chat-message';

                                // Process response to ensure proper HTML formatting
                                let formattedResponse = aiResponse;
                                // Clean up any raw text formatting and code blocks
                                formattedResponse = formattedResponse
                                    .replace(/```html?\n?/g, '')
                                    .replace(/```\n?/g, '')
                                    .trim();

                                // If response doesn't have HTML tags, wrap in paragraphs
                                if (!formattedResponse.includes('<p>') && !formattedResponse.includes('<ul>')) {
                                    formattedResponse = formattedResponse
                                        .split('\n\n')
                                        .filter(p => p.trim())
                                        .map(p => `<p>${p.trim()}</p>`)
                                        .join('');
                                }
                                aiMsg.innerHTML = `
                                    <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 bg-gray-800 rounded-lg p-3 border border-gray-700">
                                        <div class="text-sm text-gray-300 ai-message-content">${formattedResponse}</div>
                                    </div>
                                `;
                                messages.appendChild(aiMsg);
                            } else {
                                throw new Error('API request failed');
                            }
                        } catch (error) {
                            // Remove typing indicator
                            messages.removeChild(typingDiv);

                            // Fallback to predefined responses
                            const aiMsg = document.createElement('div');
                            aiMsg.className = 'flex items-start space-x-2 chat-message';
                            const fallbackResponses = [
                                "<p>Hi Asfand! I've analyzed your recent data. <strong>3 rocks are off-track</strong> and need immediate attention. Would you like me to provide details?</p>",
                                "<p>Hello Asfand! Your team's productivity has <strong>increased 12%</strong> since last quarter. The technology department is leading with all rocks on track.</p>",
                                "<p>Asfand, I notice recurring issues with customer response times. Consider adding this to next week's IDS agenda for discussion.</p>",
                                "<p>Great progress, Asfand! <strong>78% of Q1 rocks</strong> are on track or completed. Marketing and Sales teams are performing exceptionally well.</p>"
                            ];
                            aiMsg.innerHTML = `
                                <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 818 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 bg-gray-800 rounded-lg p-3 border border-gray-700">
                                    <div class="text-sm text-gray-300">${fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)]}</div>
                                </div>
                            `;
                            messages.appendChild(aiMsg);
                        }

                        messages.scrollTop = messages.scrollHeight;
                        input.value = '';
                    }
                });

                document.body.addEventListener('click', (e) => {
                    const target = e.target;

                    if (target.id === 'save-snapshot-btn') {
                        const weekId = App.getWeekId();
                        App.data.scorecardHistory[weekId] = JSON.parse(JSON.stringify(App.data.scorecard));
                        Persistence.save(App.data);
                        alert(`Snapshot for week ${weekId} saved!`);
                    }

                    // Rock modal handlers
                    if (target.id === 'add-company-rock-btn' || target.id === 'add-dept-rock-btn' ||
                        target.id === 'add-individual-rock-btn' || target.closest('.edit-rock-btn')) {
                        const rockModal = document.getElementById('rock-modal');
                        const rockForm = document.getElementById('rock-form');
                        const modalTitle = document.getElementById('rock-modal-title');
                        const deleteBtn = document.getElementById('delete-rock-btn');
                        const editBtn = target.closest('.edit-rock-btn');

                        if (rockModal && rockForm) {
                            rockForm.reset();
                            delete rockForm.dataset.rockId;
                            delete rockForm.dataset.rockType;
                            delete rockForm.dataset.dept;
                            delete rockForm.dataset.owner;

                            if (editBtn) {
                                const rockId = parseInt(editBtn.dataset.rockId);
                                const rockType = editBtn.dataset.rockType;
                                let rock;

                                if (rockType === 'company') {
                                    rock = App.data.companyRocks.find(r => r.id === rockId);
                                } else if (rockType === 'department') {
                                    const dept = editBtn.dataset.dept;
                                    rock = App.data.departmentalRocks?.[dept]?.find(r => r.id === rockId);
                                } else if (rockType === 'individual') {
                                    const owner = editBtn.dataset.owner;
                                    if (!App.data.individualRocks) App.data.individualRocks = {};
                                    rock = App.data.individualRocks[owner]?.find(r => r.id === rockId);
                                }

                                if (rock) {
                                    modalTitle.textContent = 'Edit Rock';
                                    rockForm.querySelector('[name="rock-name"]').value = rock.name || rock.title || '';
                                    rockForm.querySelector('[name="rock-type"]').value = rockType;
                                    rockForm.querySelector('[name="rock-owner"]').value = rock.owner || '';
                                    rockForm.querySelector('[name="rock-department"]').value = rock.department || editBtn.dataset.dept || '';
                                    rockForm.querySelector('[name="rock-status"]').value = rock.status || 'On Track';
                                    rockForm.querySelector('[name="rock-due"]').value = rock.dueDate || '';
                                    rockForm.querySelector('[name="rock-notes"]').value = rock.notes || '';
                                    rockForm.dataset.rockId = rockId;
                                    rockForm.dataset.rockType = rockType;
                                    rockForm.dataset.dept = editBtn.dataset.dept || '';
                                    rockForm.dataset.owner = editBtn.dataset.owner || '';
                                    deleteBtn.classList.remove('hidden');
                                }
                            } else {
                                modalTitle.textContent = 'Add New Rock';
                                deleteBtn.classList.add('hidden');

                                // Pre-select type based on button clicked
                                if (target.id === 'add-company-rock-btn') {
                                    rockForm.querySelector('[name="rock-type"]').value = 'company';
                                } else if (target.id === 'add-dept-rock-btn') {
                                    rockForm.querySelector('[name="rock-type"]').value = 'department';
                                } else if (target.id === 'add-individual-rock-btn') {
                                    rockForm.querySelector('[name="rock-type"]').value = 'individual';
                                }
                            }

                            rockModal.classList.remove('hidden');
                        }
                    }

                    // Save rock
                    if (target.id === 'save-rock-btn') {
                        const rockForm = document.getElementById('rock-form');
                        const rockModal = document.getElementById('rock-modal');

                        if (rockForm) {
                            const formData = new FormData(rockForm);
                            const rockData = {
                                name: formData.get('rock-name'),
                                title: formData.get('rock-name'), // Use both name and title for compatibility
                                type: formData.get('rock-type'),
                                owner: formData.get('rock-owner'),
                                department: formData.get('rock-department'),
                                status: formData.get('rock-status'),
                                dueDate: formData.get('rock-due'),
                                notes: formData.get('rock-notes')
                            };

                            if (!rockData.name) {
                                App.showNotification('error', 'Rock name is required');
                                return;
                            }

                            const isEdit = rockForm.dataset.rockId;
                            const rockId = isEdit ? parseInt(rockForm.dataset.rockId) : Date.now();

                            const rock = {
                                id: rockId,
                                ...rockData,
                                quarter: 'Q1 2025'
                            };

                            // Initialize data structures if needed
                            if (!App.data.departmentalRocks) App.data.departmentalRocks = {};
                            if (!App.data.individualRocks) App.data.individualRocks = {};

                            if (rockData.type === 'company') {
                                if (isEdit) {
                                    const index = App.data.companyRocks.findIndex(r => r.id === rockId);
                                    if (index > -1) App.data.companyRocks[index] = rock;
                                } else {
                                    App.data.companyRocks.push(rock);
                                }
                            } else if (rockData.type === 'department' && rockData.department) {
                                if (!App.data.departmentalRocks[rockData.department]) {
                                    App.data.departmentalRocks[rockData.department] = [];
                                }
                                if (isEdit) {
                                    const index = App.data.departmentalRocks[rockData.department].findIndex(r => r.id === rockId);
                                    if (index > -1) App.data.departmentalRocks[rockData.department][index] = rock;
                                } else {
                                    App.data.departmentalRocks[rockData.department].push(rock);
                                }
                            } else if (rockData.type === 'individual' && rockData.owner) {
                                if (!App.data.individualRocks[rockData.owner]) {
                                    App.data.individualRocks[rockData.owner] = [];
                                }
                                if (isEdit) {
                                    const index = App.data.individualRocks[rockData.owner].findIndex(r => r.id === rockId);
                                    if (index > -1) App.data.individualRocks[rockData.owner][index] = rock;
                                } else {
                                    App.data.individualRocks[rockData.owner].push(rock);
                                }
                            }

                            Persistence.save(App.data);
                            App.showNotification('success', isEdit ? 'Rock updated successfully' : 'Rock added successfully');
                            rockModal.classList.add('hidden');
                            App.router();
                        }
                    }

                    // Delete rock
                    if (target.id === 'delete-rock-btn') {
                        const rockForm = document.getElementById('rock-form');
                        const rockModal = document.getElementById('rock-modal');

                        if (rockForm && rockForm.dataset.rockId && confirm('Are you sure you want to delete this rock?')) {
                            const rockId = parseInt(rockForm.dataset.rockId);
                            const rockType = rockForm.dataset.rockType;

                            if (rockType === 'company') {
                                App.data.companyRocks = App.data.companyRocks.filter(r => r.id !== rockId);
                            } else if (rockType === 'department') {
                                const dept = rockForm.dataset.dept;
                                if (App.data.departmentalRocks?.[dept]) {
                                    App.data.departmentalRocks[dept] = App.data.departmentalRocks[dept].filter(r => r.id !== rockId);
                                }
                            } else if (rockType === 'individual') {
                                const owner = rockForm.dataset.owner;
                                if (App.data.individualRocks?.[owner]) {
                                    App.data.individualRocks[owner] = App.data.individualRocks[owner].filter(r => r.id !== rockId);
                                }
                            }

                            Persistence.save(App.data);
                            App.showNotification('success', 'Rock deleted successfully');
                            rockModal.classList.add('hidden');
                            App.router();
                        }
                    }

                    // Cancel rock modal
                    if (target.id === 'cancel-rock-btn') {
                        const rockModal = document.getElementById('rock-modal');
                        if (rockModal) rockModal.classList.add('hidden');
                    }

                    // Modal close on backdrop click
                    if (target.id === 'rock-modal' && target === e.currentTarget) {
                        target.classList.add('hidden');
                    }

                    // Employee modal handlers
                    if (target.id === 'add-employee-btn' || target.closest('.edit-employee-btn')) {
                        const empModal = document.getElementById('employee-modal');
                        const empForm = document.getElementById('employee-form');
                        const modalTitle = document.getElementById('employee-modal-title');
                        const deleteBtn = document.getElementById('delete-employee-btn');
                        const editBtn = target.closest('.edit-employee-btn');

                        if (empModal && empForm) {
                            empForm.reset();
                            delete empForm.dataset.employeeId;

                            if (editBtn) {
                                const empId = parseInt(editBtn.dataset.employeeId);
                                const employee = App.data.employees.find(e => e.id === empId);

                                if (employee) {
                                    modalTitle.textContent = 'Edit Employee';
                                    empForm.querySelector('[name="employee-name"]').value = employee.name || '';
                                    empForm.querySelector('[name="employee-role"]').value = employee.role || '';
                                    empForm.querySelector('[name="employee-department"]').value = employee.department || '';
                                    empForm.querySelector('[name="employee-email"]').value = employee.email || '';
                                    empForm.dataset.employeeId = empId;
                                    deleteBtn.classList.remove('hidden');
                                }
                            } else {
                                modalTitle.textContent = 'Add New Employee';
                                deleteBtn.classList.add('hidden');
                            }

                            empModal.classList.remove('hidden');
                        }
                    }

                    // Save employee
                    if (target.id === 'save-employee-btn') {
                        const empForm = document.getElementById('employee-form');
                        const empModal = document.getElementById('employee-modal');

                        if (empForm) {
                            const formData = new FormData(empForm);
                            const empData = {
                                name: formData.get('employee-name'),
                                role: formData.get('employee-role'),
                                department: formData.get('employee-department'),
                                email: formData.get('employee-email')
                            };

                            if (!empData.name) {
                                App.showNotification('error', 'Employee name is required');
                                return;
                            }

                            const isEdit = empForm.dataset.employeeId;
                            const empId = isEdit ? parseInt(empForm.dataset.employeeId) : Date.now();

                            const employee = {
                                id: empId,
                                ...empData
                            };

                            if (isEdit) {
                                const index = App.data.employees.findIndex(e => e.id === empId);
                                if (index > -1) App.data.employees[index] = employee;
                            } else {
                                App.data.employees.push(employee);
                            }

                            // Update department members if department is assigned
                            if (empData.department && App.data.departments[empData.department]) {
                                const dept = App.data.departments[empData.department];
                                if (!dept.members) dept.members = [];
                                if (!dept.members.includes(empData.name)) {
                                    dept.members.push(empData.name);
                                }
                            }

                            Persistence.save(App.data);
                            App.showNotification('success', isEdit ? 'Employee updated successfully' : 'Employee added successfully');
                            empModal.classList.add('hidden');
                            App.router();
                        }
                    }

                    // Delete employee
                    if (target.id === 'delete-employee-btn') {
                        const empForm = document.getElementById('employee-form');
                        const empModal = document.getElementById('employee-modal');

                        if (empForm && empForm.dataset.employeeId && confirm('Are you sure you want to delete this employee?')) {
                            const empId = parseInt(empForm.dataset.employeeId);
                            const employee = App.data.employees.find(e => e.id === empId);

                            // Remove from employees array
                            App.data.employees = App.data.employees.filter(e => e.id !== empId);

                            // Remove from department members
                            if (employee && employee.department && App.data.departments[employee.department]) {
                                const dept = App.data.departments[employee.department];
                                if (dept.members) {
                                    dept.members = dept.members.filter(m => m !== employee.name);
                                }
                            }

                            // Remove associated individual rocks
                            if (employee && App.data.individualRocks?.[employee.name]) {
                                delete App.data.individualRocks[employee.name];
                            }

                            Persistence.save(App.data);
                            App.showNotification('success', 'Employee deleted successfully');
                            empModal.classList.add('hidden');
                            App.router();
                        }
                    }

                    // Cancel employee modal
                    if (target.id === 'cancel-employee-btn') {
                        const empModal = document.getElementById('employee-modal');
                        if (empModal) empModal.classList.add('hidden');
                    }

                    // Employee modal close on backdrop click
                    if (target.id === 'employee-modal' && target === e.currentTarget) {
                        target.classList.add('hidden');
                    }

                    // Metric modal handlers
                    if (target.id === 'add-metric-btn' || target.closest('.edit-metric-btn')) {
                        const metricModal = document.getElementById('metric-modal');
                        const metricForm = document.getElementById('metric-form');
                        const modalTitle = document.getElementById('metric-modal-title');
                        const deleteBtn = document.getElementById('delete-metric-btn');
                        const deptSelect = document.getElementById('metric-department-select');
                        const typeSelect = metricForm?.querySelector('[name="metric-type"]');

                        if (metricModal && metricForm) {
                            metricForm.reset();
                            delete metricForm.dataset.metricIndex;
                            delete metricForm.dataset.scorecardType;
                            delete metricForm.dataset.department;

                            const scorecardType = target.dataset.scorecardType || 'company';
                            const department = target.dataset.department;

                            modalTitle.textContent = 'Add New Metric';
                            deleteBtn.classList.add('hidden');

                            if (typeSelect) {
                                typeSelect.value = department ? 'department' : 'company';
                                if (department) {
                                    deptSelect.classList.remove('hidden');
                                    metricForm.querySelector('[name="metric-department"]').value = department;
                                } else {
                                    deptSelect.classList.add('hidden');
                                }
                            }

                            metricModal.classList.remove('hidden');

                            // Show/hide department select based on type
                            typeSelect?.addEventListener('change', (e) => {
                                if (e.target.value === 'department') {
                                    deptSelect.classList.remove('hidden');
                                } else {
                                    deptSelect.classList.add('hidden');
                                }
                            });
                        }
                    }

                    // Save metric
                    if (target.id === 'save-metric-btn') {
                        const metricForm = document.getElementById('metric-form');
                        const metricModal = document.getElementById('metric-modal');

                        if (metricForm) {
                            const formData = new FormData(metricForm);
                            const metricData = {
                                metric: formData.get('metric-name'),
                                goal: formData.get('metric-goal'),
                                value: formData.get('metric-value'),
                                type: formData.get('metric-type'),
                                department: formData.get('metric-department'),
                                trend: []
                            };

                            if (!metricData.metric) {
                                App.showNotification('error', 'Metric name is required');
                                return;
                            }

                            if (metricData.type === 'company') {
                                App.data.scorecard.push(metricData);
                            } else if (metricData.type === 'department' && metricData.department) {
                                if (!App.data.departmentalScorecards) App.data.departmentalScorecards = {};
                                if (!App.data.departmentalScorecards[metricData.department]) {
                                    App.data.departmentalScorecards[metricData.department] = [];
                                }
                                App.data.departmentalScorecards[metricData.department].push(metricData);
                            }

                            Persistence.save(App.data);
                            App.showNotification('success', 'Metric added successfully');
                            metricModal.classList.add('hidden');
                            App.router();
                        }
                    }

                    // Cancel metric modal
                    if (target.id === 'cancel-metric-btn') {
                        const metricModal = document.getElementById('metric-modal');
                        if (metricModal) metricModal.classList.add('hidden');
                    }

                    // Google Meet Sync simulation
                    if (target.id === 'sync-meet-btn' || target.classList.contains('google-meet-sync')) {
                        const spinner = document.getElementById('sync-spinner');
                        if (spinner) {
                            spinner.classList.remove('hidden');
                        }
                        App.showNotification('info', 'Syncing with Google Meet...');

                        setTimeout(() => {
                            if (spinner) spinner.classList.add('hidden');
                            App.showNotification('success', 'Google Meet sync complete! 3 new transcripts available.');

                            // Update meeting data
                            if (App.data.meetingHistory.length > 0) {
                                App.data.meetingHistory.hasTranscript = true;
                                App.data.meetingHistory.hasRecording = true;
                                Persistence.save(App.data);
                            }
                        }, 2000);
                    }

                    // Webhook simulation
                    if (target.classList.contains('simulate-webhook')) {
                        App.simulateWebhookUpdate();
                        App.showNotification('info', 'Webhook test triggered!');
                    }

                    // Add customer/employee headline rows
                    if (target.id === 'add-customer-headline') {
                        const table = document.getElementById('customer-headlines-table');
                        if (table) {
                            const newRow = table.insertRow();
                            newRow.className = 'border-b border-gray-700';
                            newRow.innerHTML = table.rows.innerHTML;
                            newRow.querySelectorAll('input, select').forEach(el => el.value = '');
                        }
                    }

                    if (target.id === 'add-employee-headline') {
                        const table = document.getElementById('employee-headlines-table');
                        if (table) {
                            const newRow = table.insertRow();
                            newRow.className = 'border-b border-gray-700';
                            newRow.innerHTML = table.rows.innerHTML;
                            newRow.querySelectorAll('input, select').forEach(el => el.value = '');
                        }
                    }

                    // Add Issue button handler
                    if (target.classList.contains('add-issue-btn')) {
                        App.showAddIssueModal();
                    }

                    // Edit Issue handler
                    if (target.classList.contains('edit-issue-btn')) {
                        const issueId = parseInt(target.dataset.issueId);
                        const issue = App.data.issues.find(i => i.id === issueId);
                        if (issue) {
                            UI.showModal({
                                title: 'Edit Issue',
                                contentHTML: `
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm text-gray-300 mb-1">Issue Title</label>
                                            <input id="edit-issue-title" type="text" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white" value="${Security.escapeHtml(issue.title)}">
                                        </div>
                                        <div>
                                            <label class="block text-sm text-gray-300 mb-1">Description</label>
                                            <textarea id="edit-issue-description" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white" rows="3">${Security.escapeHtml(issue.description || '')}</textarea>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm text-gray-300 mb-1">Priority</label>
                                                <select id="edit-issue-priority" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white">
                                                    <option value="1" ${issue.priority === 1 ? 'selected' : ''}>1 - Critical</option>
                                                    <option value="2" ${issue.priority === 2 ? 'selected' : ''}>2 - High</option>
                                                    <option value="3" ${issue.priority === 3 ? 'selected' : ''}>3 - Normal</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm text-gray-300 mb-1">Department</label>
                                                <select id="edit-issue-department" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white">
                                                    <option value="technology" ${issue.department === 'technology' ? 'selected' : ''}>Technology</option>
                                                    <option value="marketing" ${issue.department === 'marketing' ? 'selected' : ''}>Marketing</option>
                                                    <option value="operations" ${issue.department === 'operations' ? 'selected' : ''}>Operations</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                `,
                                onSubmit: (content) => {
                                    issue.title = content.querySelector('#edit-issue-title').value.trim();
                                    issue.description = content.querySelector('#edit-issue-description').value.trim();
                                    issue.priority = parseInt(content.querySelector('#edit-issue-priority').value);
                                    issue.department = content.querySelector('#edit-issue-department').value;

                                    Persistence.save(App.data);
                                    UI.hideModal();
                                    App.showNotification('success', 'Issue updated successfully');
                                    App.router();
                                },
                                submitText: 'Save Changes'
                            });
                        }
                    }

                    // Delete Issue handler
                    if (target.classList.contains('delete-issue-btn')) {
                        const issueId = parseInt(target.dataset.issueId);
                        if (confirm('Are you sure you want to delete this issue?')) {
                            App.deleteIssue(issueId);
                        }
                    }

                    // Add headlines to IDS from tables
                    if (target.classList.contains('customer-to-ids') || target.classList.contains('employee-to-ids')) {
                        const row = target.closest('tr');
                        if (row) {
                            const inputs = row.querySelectorAll('input, select');
                            const headline = inputs?.value || inputs?.value || 'Issue from headlines';
                            if (headline) {
                                const newIssue = {
                                    id: Date.now(),
                                    title: headline,
                                    priority: 2,
                                    status: 'Open'
                                };
                                App.data.l10Data.meetingIssues.push(newIssue);
                                App.showNotification('success', 'Added to IDS list!');
                            }
                        }
                    }

                    // VTO Edit handlers
                    if (target.classList.contains('vto-editable')) {
                        target.addEventListener('blur', function() {
                            const field = this.dataset.field;
                            const index = this.dataset.index;
                            const value = this.textContent.trim();

                            if (field.includes('.')) {
                                const [parent, child] = field.split('.');
                                App.data.vto[parent][child] = value;
                            } else if (index !== undefined) {
                                App.data.vto[field][index] = value;
                            } else {
                                App.data.vto[field] = value;
                            }

                            Persistence.save(App.data);
                            App.hasUnsavedChanges = true;
                        }, { once: true });
                    }

                    // Remove VTO value
                    if (target.classList.contains('remove-value')) {
                        const field = target.dataset.field;
                        const index = parseInt(target.dataset.index);

                        if (field.includes('.')) {
                            const [parent, child] = field.split('.');
                            App.data.vto[parent][child].splice(index, 1);
                        } else {
                            App.data.vto[field].splice(index, 1);
                        }

                        Persistence.save(App.data);
                        App.router();
                    }

                    // Save VTO
                    if (target.id === 'save-vto-btn') {
                        Persistence.save(App.data);
                        App.showNotification('success', 'V/TO saved successfully!');
                    }

                    // View history
                    if (target.id === 'view-history-btn') {
                        const history = App.data.scorecardHistory || {};
                        const weeks = Object.keys(history).sort().reverse().slice(0, 12);

                        if (weeks.length === 0) {
                            App.showNotification('info', 'No historical snapshots available');
                            return;
                        }

                        const historyHTML = `
                            <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" id="history-modal">
                                <div class="bg-gray-800 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                                    <div class="p-6 border-b border-gray-700">
                                        <h3 class="text-xl font-bold text-white">Scorecard History</h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            ${weeks.map(week => {
                                                const snapshot = history[week];
                                                return `
                                                    <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                                        <h4 class="font-semibold text-white mb-3">Week ${week}</h4>
                                                        <div class="space-y-2">
                                                            ${snapshot.slice(0, 5).map(item => {
                                                                const numGoal = parseFloat(String(item.goal).replace(/[^0-9.-]/g, '')) || 0;
                                                                const numValue = parseFloat(String(item.value).replace(/[^0-9.-]/g, '')) || 0;
                                                                const onTarget = numValue >= numGoal;
                                                                return `
                                                                    <div class="flex justify-between items-center text-sm">
                                                                        <span class="text-gray-400">${item.metric}</span>
                                                                        <span class="${onTarget ? 'text-green-400' : 'text-red-400'}">${item.value}</span>
                                                                    </div>
                                                                `;
                                                            }).join('')}
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="p-6 border-t border-gray-700">
                                        <button onclick="document.getElementById('history-modal').remove()" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Close</button>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.body.insertAdjacentHTML('beforeend', historyHTML);
                    }
                });
            },

            addVtoValue(field) {
                const value = prompt(`Enter new ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}:`);
                if (value) {
                    const fields = field.split('.');
                    if (fields.length === 1) {
                        App.data.vto[field].push(value);
                    } else {
                        App.data.vto[fields][fields].push(value);
                    }
                    Persistence.save(App.data);
                    App.router();
                }
            },

            showNotification(type, message) {
                const colors = {
                    success: 'bg-green-600',
                    error: 'bg-red-600',
                    warning: 'bg-amber-600',
                    info: 'bg-blue-600'
                };
                const notification = document.createElement('div');
                notification.className = `fixed bottom-20 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-40 transition-opacity duration-500`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            },

            showAddIssueModal() {
                UI.showModal({
                    title: 'Add New Issue',
                    contentHTML: `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">Issue Title</label>
                                <input id="issue-title" type="text" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white" placeholder="Enter issue title">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">Description</label>
                                <textarea id="issue-description" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white" rows="3"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Priority</label>
                                    <select id="issue-priority" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white">
                                        <option value="1">1 - Critical</option>
                                        <option value="2">2 - High</option>
                                        <option value="3" selected>3 - Normal</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Department</label>
                                    <select id="issue-department" class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white">
                                        <option value="technology">Technology</option>
                                        <option value="marketing">Marketing</option>
                                        <option value="operations">Operations</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `,
                    onSubmit: (content) => {
                        const title = content.querySelector('#issue-title').value.trim();
                        const description = content.querySelector('#issue-description').value.trim();
                        const priority = parseInt(content.querySelector('#issue-priority').value);
                        const department = content.querySelector('#issue-department').value;

                        if (!title) {
                            alert('Please enter an issue title');
                            return;
                        }

                        const newIssue = {
                            id: Date.now(),
                            title,
                            description,
                            priority,
                            department,
                            age: 0
                        };

                        App.data.issues.push(newIssue);
                        Persistence.save(App.data);
                        UI.hideModal();
                        App.showNotification('success', 'Issue added successfully');
                        App.render('issues');
                    },
                    submitText: 'Add Issue'
                });
            },

            deleteIssue(issueId) {
                App.data.issues = App.data.issues.filter(i => i.id !== issueId);
                Persistence.save(App.data);
                App.showNotification('success', 'Issue deleted');
                App.render('issues');
            },

            renderSidebar() {
                const navLinks = [
                    { href: '#dashboard', icon: Icons.home(), text: 'Dashboard' },
                    { href: '#vto', icon: Icons.vision(), text: 'V/TO' },
                    { href: '#departments', icon: Icons.departments(), text: 'Departments' },
                    { href: '#people', icon: Icons.people(), text: 'People' },
                    { href: '#data', icon: Icons.data(), text: 'Data' },
                    { href: '#issues', icon: Icons.issues(), text: 'Issues' },
                    { href: '#rocks', icon: Icons.rocks(), text: 'Rocks' },
                    { href: '#l10', icon: Icons.meetings(), text: 'Level 10 Meeting', isSpecial: true },
                    { href: '#integrations', icon: Icons.integrations(), text: 'Integrations' }
                ];
                const navContainer = document.getElementById('sidebar-nav');
                navContainer.innerHTML = navLinks.map(link => `
                    <a href="${link.href}" class="nav-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-gray-800 ${link.isSpecial ? 'bg-indigo-600 font-bold text-white hover:bg-indigo-700' : ''}">
                        <span class="w-6 mr-3">${link.icon}</span> ${link.text}
                    </a>`).join('');
            },

            navigate(hash, param) {
                const newLocation = param ? `${hash}/${param}` : hash;
                window.location.hash = newLocation;
            },
            
            router() {
                // Clean up charts before navigation
                if (this._charts && this._charts.length > 0) {
                    this._charts.forEach(chart => {
                        try { chart.destroy(); } catch(e) {}
                    });
                    this._charts = [];
                }

                const [hash, param] = (window.location.hash || '#dashboard').split('/');
                const pageTitle = document.getElementById('page-title');

                document.querySelectorAll('.nav-link.active').forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
                if (activeLink) activeLink.classList.add('active');

                const sidebar = document.getElementById('sidebar');
                if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                    document.getElementById('menu-button').click();
                }
                document.getElementById('main-scroll-area').scrollTop = 0;

                if (hash === '#departments' && param) {
                    const deptName = this.data.departments[param]?.name || 'Departments';
                    pageTitle.textContent = `${deptName} Department`;
                    this.render('departmentDetail', param);
                    return;
                }

                const routes = {
                    '#dashboard': { title: 'Dashboard', page: 'dashboard' },
                    '#vto': { title: 'Vision/Traction Organizer', page: 'vto' },
                    '#departments': { title: 'Departments', page: 'departments' },
                    '#people': { title: 'People', page: 'people' },
                    '#data': { title: 'Data', page: 'data' },
                    '#issues': { title: 'Issues', page: 'issues' },
                    '#rocks': { title: 'Rocks', page: 'rocks' },
                    '#l10': { title: 'Level 10 Meeting', page: 'l10' },
                    '#integrations': { title: 'Integrations', page: 'integrations' }
                };

                const route = routes[hash] || routes['#dashboard'];
                pageTitle.textContent = route.title;
                this.render(route.page, param);
            },
            
            render(page, param) {
                const mainApp = document.getElementById('main-app');
                // Fallback if page doesn't exist
                if (!this.pages[page]) {
                    console.warn(`Page '${page}' not found, defaulting to dashboard`);
                    page = 'dashboard';
                }
                mainApp.innerHTML = this.pages[page](param);
                if (page === 'dashboard' || page === 'data' || page === 'departmentDetail') {
                    setTimeout(() => this.renderCharts(), 0);
                }
                if(page === 'l10') this.initL10();
            },
            
            pages: {
                dashboard() {
                    const { scorecard, companyRocks, departmentRocks, individualRocks, issues, meetingHistory, todos } = App.data;
                    const getNumber = (value) => {
                        const parsed = parseFloat(String(value ?? '').replace(/[^0-9.-]/g, ''));
                        return Number.isFinite(parsed) ? parsed : 0;
                    };

                    // Calculate metrics
                    const salesMetric = scorecard || {};
                    const csatMetric = scorecard.find(item => item.metric.toLowerCase().includes('csat')) || {};

                    // Rocks metrics
                    const allDeptRocks = Object.values(departmentRocks || {}).flat();
                    const allRocks = [...companyRocks, ...allDeptRocks, ...(individualRocks || [])];
                    const onTrackRocks = allRocks.filter(r => r.status === 'On Track').length;
                    const offTrackRocks = allRocks.filter(r => r.status === 'Off Track').length;
                    const doneRocks = allRocks.filter(r => r.status === 'Done').length;

                    // Todos and Issues
                    const totalTodos = (todos || []).filter(t => !t.completed).length;
                    const criticalIssues = issues.filter(i => i.priority === 1).length;

                    const salesValue = getNumber(salesMetric.value);
                    const salesGoal = getNumber(salesMetric.goal);
                    const salesDelta = salesGoal ? ((salesValue - salesGoal) / salesGoal) * 100 : 0;
                    const csatValue = getNumber(csatMetric.value);
                    const csatGoal = getNumber(csatMetric.goal);
                    const csatDelta = csatGoal ? csatValue - csatGoal : 0;
                    const topIssues = issues.slice().sort((a, b) => a.priority - b.priority).slice(0, 3);

                    return `
                        <div class="bg-indigo-900/50 border border-indigo-500/30 text-white p-6 rounded-lg shadow-lg mb-6">
                            <div class="flex items-start">
                                <span class="mr-4 mt-1 text-indigo-400">${Icons.ai()}</span>
                                <div>
                                    <h3 class="font-bold text-xl text-indigo-300">AI Analyst Summary</h3>
                                    ${AI.analyze(App.data)}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                            <div class="xl:col-span-2 space-y-6">
                                <!-- Top Metrics Row -->
                                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                                        <p class="text-xs text-gray-400 font-medium">Total To-Dos</p>
                                        <p class="text-xl font-bold text-white mt-1">${totalTodos}</p>
                                        <p class="text-xs text-gray-500 mt-1">Active</p>
                                    </div>
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                                        <p class="text-xs text-gray-400 font-medium">Critical Issues</p>
                                        <p class="text-xl font-bold text-rose-400 mt-1">${criticalIssues}</p>
                                        <p class="text-xs text-gray-500 mt-1">Priority 1</p>
                                    </div>
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                                        <p class="text-xs text-gray-400 font-medium">On Track Rocks</p>
                                        <p class="text-xl font-bold text-emerald-400 mt-1">${onTrackRocks}</p>
                                        <p class="text-xs text-gray-500 mt-1">of ${allRocks.length}</p>
                                    </div>
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                                        <p class="text-xs text-gray-400 font-medium">Off Track Rocks</p>
                                        <p class="text-xl font-bold text-amber-400 mt-1">${offTrackRocks}</p>
                                        <p class="text-xs text-gray-500 mt-1">Need attention</p>
                                    </div>
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                                        <p class="text-xs text-gray-400 font-medium">Weekly Sales</p>
                                        <p class="text-xl font-bold text-white mt-1">$${Math.round(salesValue/1000)}k</p>
                                        <p class="text-xs ${salesDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'} mt-1">${salesDelta >= 0 ? '+' : ''}${Math.round(salesDelta)}%</p>
                                    </div>
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                                        <p class="text-xs text-gray-400 font-medium">CSAT</p>
                                        <p class="text-xl font-bold ${csatDelta >= 0 ? 'text-emerald-400' : 'text-rose-400'} mt-1">${csatMetric.value ?? '--'}%</p>
                                        <p class="text-xs text-gray-500 mt-1">Goal: ${csatMetric.goal}%</p>
                                    </div>
                                </div>

                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-semibold text-white text-lg">Sales Trend</h3>
                                        <span class="text-sm text-gray-400">Last 4 weeks</span>
                                    </div>
                                    <canvas id="salesChart" class="h-48"></canvas>
                                </div>

                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="font-semibold text-white text-lg mb-4">Scorecard Snapshot</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                        ${scorecard.map(item => {
                                            const goal = getNumber(item.goal);
                                            const value = getNumber(item.value);
                                            const isTimeMetric = item.metric.toLowerCase().includes('time');
                                            const onTarget = isTimeMetric ? value <= goal : value >= goal;
                                            return `
                                                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 flex justify-between items-center">
                                                    <div>
                                                        <p class="text-sm text-gray-400">${item.metric}</p>
                                                        <p class="text-xl font-semibold ${onTarget ? 'text-emerald-400' : 'text-rose-400'}">${item.value}</p>
                                                        <p class="text-xs text-gray-500">Goal: ${item.goal}</p>
                                                    </div>
                                                    <div class="w-24 h-12">
                                                        <canvas class="scorecard-chart" data-trend='${JSON.stringify(item.trend)}' data-good="${onTarget}"></canvas>
                                                    </div>
                                                </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-semibold text-white text-lg">Recent L10 Meetings</h3>
                                        <a href="#l10" class="text-indigo-400 hover:text-indigo-300 text-sm">View all →</a>
                                    </div>
                                    <ul class="space-y-3">
                                        ${meetingHistory.slice(0, 3).map(meeting => {
                                            const dept = App.data.departments[meeting.department] || {};
                                            return `
                                            <li class="flex justify-between items-start p-3 bg-gray-900/60 rounded-md">
                                                <div class="flex-1">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-xs px-2 py-1 bg-gray-700 text-gray-300 rounded">${dept.name || meeting.department}</span>
                                                        <p class="font-semibold text-gray-200">${meeting.date}</p>
                                                    </div>
                                                    <p class="text-sm text-gray-400 mt-1">${meeting.keyTopics.join(', ')}</p>
                                                    ${meeting.transcriptionUrl ? `<a href="${meeting.transcriptionUrl}" target="_blank" class="text-xs text-indigo-400 hover:underline mt-1 inline-flex items-center">
                                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                                        Recording
                                                    </a>` : ''}
                                                </div>
                                                <span class="text-sm font-bold text-indigo-400 ml-3">Rating: ${meeting.rating}/10</span>
                                            </li>`;
                                        }).join('') || '<li class="text-gray-500">No meetings logged.</li>'}
                                    </ul>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="font-semibold text-white text-lg mb-4">Top Issues To Discuss</h3>
                                    <ul class="space-y-3">
                                        ${topIssues.map(issue => `
                                            <li class="bg-gray-900/60 border border-gray-800 rounded-md p-3">
                                                <p class="font-semibold text-gray-200">${issue.title}</p>
                                                <p class="text-xs text-gray-400">Priority ${issue.priority} &amp;bull; Age ${issue.age} days</p>
                                            </li>`).join('') || '<li class="text-gray-500">All clear for now.</li>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                },
                vto() {
                    const vto = App.data.vto;
                    return `
                        <div class="bg-gray-800 border border-gray-700 p-6 sm:p-8 rounded-lg shadow">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-white">Vision/Traction Organizer™</h2>
                                <p class="text-gray-400">for ${App.data.companyName}</p>
                            </div>

                            <div class="space-y-8">
                                <!-- Core Values -->
                                <div>
                                    <h3 class="text-xl font-semibold text-indigo-400 border-b border-gray-700 pb-2 mb-3">Core Values</h3>
                                    <div class="flex flex-wrap gap-3" id="core-values-container">
                                        ${vto.coreValues.map((v, i) => `
                                            <div class="bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-full text-sm font-medium flex items-center gap-2">
                                                <span contenteditable="true" class="vto-editable outline-none" data-field="coreValues" data-index="${i}">${v}</span>
                                                <button class="remove-value text-red-400 hover:text-red-300" data-field="coreValues" data-index="${i}">&times;</button>
                                            </div>
                                        `).join('')}
                                        <button class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded-full text-sm" onclick="App.addVtoValue('coreValues')">+ Add</button>
                                    </div>
                                </div>

                                <!-- Core Focus -->
                                <div>
                                    <h3 class="text-xl font-semibold text-indigo-400 border-b border-gray-700 pb-2 mb-3">Core Focus™</h3>
                                    <div class="space-y-2">
                                        <p>
                                            <strong class="font-medium text-gray-300">Purpose/Cause/Passion:</strong>
                                            <span contenteditable="true" class="vto-editable outline-none bg-gray-900 px-2 py-1 rounded ml-2" data-field="coreFocus.purpose">${vto.coreFocus.purpose}</span>
                                        </p>
                                        <p>
                                            <strong class="font-medium text-gray-300">Our Niche:</strong>
                                            <span contenteditable="true" class="vto-editable outline-none bg-gray-900 px-2 py-1 rounded ml-2" data-field="coreFocus.niche">${vto.coreFocus.niche}</span>
                                        </p>
                                    </div>
                                </div>

                                <!-- 10-Year Target -->
                                <div>
                                    <h3 class="text-xl font-semibold text-indigo-400 border-b border-gray-700 pb-2 mb-3">10-Year Target™</h3>
                                    <p contenteditable="true" class="vto-editable outline-none bg-gray-900 px-3 py-2 rounded" data-field="tenYearTarget">${vto.tenYearTarget}</p>
                                </div>

                                <!-- Marketing Strategy -->
                                <div>
                                    <h3 class="text-xl font-semibold text-indigo-400 border-b border-gray-700 pb-2 mb-3">Marketing Strategy™</h3>
                                    <p class="mb-3">
                                        <strong class="font-medium text-gray-300">Target Market:</strong>
                                        <span contenteditable="true" class="vto-editable outline-none bg-gray-900 px-2 py-1 rounded ml-2" data-field="marketingStrategy.targetMarket">${vto.marketingStrategy.targetMarket}</span>
                                    </p>
                                    <p class="font-medium text-gray-300 mb-2">Three Uniques™:</p>
                                    <ul class="list-disc list-inside ml-4 space-y-1">
                                        ${vto.marketingStrategy.threeUniques.map((u, i) => `
                                            <li>
                                                <span contenteditable="true" class="vto-editable outline-none bg-gray-900 px-2 py-1 rounded" data-field="marketingStrategy.threeUniques" data-index="${i}">${u}</span>
                                                <button class="remove-value text-red-400 hover:text-red-300 ml-2" data-field="marketingStrategy.threeUniques" data-index="${i}">&times;</button>
                                            </li>
                                        `).join('')}
                                    </ul>
                                    <button class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-sm mt-2" onclick="App.addVtoValue('marketingStrategy.threeUniques')">+ Add Unique</button>
                                </div>

                                <!-- 3-Year Picture -->
                                <div>
                                    <h3 class="text-xl font-semibold text-indigo-400 border-b border-gray-700 pb-2 mb-3">3-Year Picture™</h3>
                                    <p contenteditable="true" class="vto-editable outline-none bg-gray-900 px-3 py-2 rounded" data-field="threeYearPicture">${vto.threeYearPicture}</p>
                                </div>

                                <!-- 1-Year Plan -->
                                <div>
                                    <h3 class="text-xl font-semibold text-indigo-400 border-b border-gray-700 pb-2 mb-3">1-Year Plan™</h3>
                                    <ul class="list-disc list-inside space-y-1">
                                        ${vto.oneYearPlan.map((p, i) => `
                                            <li>
                                                <span contenteditable="true" class="vto-editable outline-none bg-gray-900 px-2 py-1 rounded" data-field="oneYearPlan" data-index="${i}">${p}</span>
                                                <button class="remove-value text-red-400 hover:text-red-300 ml-2" data-field="oneYearPlan" data-index="${i}">&times;</button>
                                            </li>
                                        `).join('')}
                                    </ul>
                                    <button class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-sm mt-2" onclick="App.addVtoValue('oneYearPlan')">+ Add Goal</button>
                                </div>
                            </div>

                            <div class="mt-8 text-center">
                                <button id="save-vto-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-semibold">Save V/TO Changes</button>
                            </div>
                        </div>
                    `;
                },
                 people() {
                    const { employees, departments, individualRocks } = App.data;

                    // Group employees by department
                    const employeesByDept = {};
                    employees.forEach(emp => {
                        const dept = emp.department || 'unassigned';
                        if (!employeesByDept[dept]) employeesByDept[dept] = [];
                        employeesByDept[dept].push(emp);
                    });

                    return `
                        <div class="space-y-6">
                            <!-- Accountability Chart -->
                            <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                <h2 class="text-2xl font-bold text-white mb-6">Accountability Chart</h2>
                                <div class="overflow-x-auto p-4">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-center w-64">
                                            <p class="font-bold text-lg text-white">Visionary / Integrator</p>
                                            <p class="text-gray-400">Asfand Yaar</p>
                                        </div>
                                        <div class="h-8 w-px bg-gray-700"></div>
                                        <div class="w-full border-t-2 border-gray-700"></div>
                                        <div class="flex flex-wrap justify-center pt-8">
                                            ${Object.entries(departments).map(([key, dept]) => `
                                                <div class="flex flex-col items-center mx-4 my-4">
                                                    <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-center w-48">
                                                        <p class="font-bold text-white">${dept.name}</p>
                                                        <p class="text-gray-400">${dept.head}</p>
                                                    </div>
                                                    <div class="h-8 w-px bg-gray-700"></div>
                                                    <div class="flex flex-wrap justify-center w-48">
                                                        ${dept.members.map(m => `<span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 m-1 rounded-full">${m.split(' ')[0]}</span>`).join('')}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Employee Directory -->
                            <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-white">Employee Directory</h2>
                                    <button id="add-employee-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-500">+ Add Employee</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${employees.map(emp => {
                                        const empRocks = individualRocks.filter(r => r.employeeId === emp.id);
                                        const dept = departments[emp.department];
                                        return `
                                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 relative group">
                                                <button class="edit-employee-btn absolute top-2 right-2 bg-gray-700 hover:bg-indigo-600 text-gray-300 hover:text-white p-2 rounded-lg transition-colors" data-employee-id="${emp.id}">
                                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                                                </button>
                                                <div class="flex items-start justify-between mb-2">
                                                    <div>
                                                        <p class="font-semibold text-white">${emp.name}</p>
                                                        <p class="text-sm text-gray-400">${emp.role}</p>
                                                        <p class="text-xs text-indigo-400 mt-1">${dept?.name || emp.department}</p>
                                                    </div>
                                                    <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">
                                                        ${emp.name.split(' ').map(n => n).join('')}
                                                    </div>
                                                </div>
                                                ${empRocks.length > 0 ? `
                                                    <div class="mt-3 pt-3 border-t border-gray-700">
                                                        <p class="text-xs text-gray-500 mb-2">Individual Rocks (${empRocks.length}):</p>
                                                        ${empRocks.map(rock => `
                                                            <div class="text-xs text-gray-300 mb-1 flex items-center">
                                                                <span class="w-2 h-2 rounded-full mr-1 ${rock.status === 'On Track' ? 'bg-green-500' : rock.status === 'Off Track' ? 'bg-red-500' : 'bg-blue-500'}"></span>
                                                                ${rock.title.substring(0, 30)}${rock.title.length > 30 ? '...' : ''}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : '<p class="text-xs text-gray-500 mt-3">No individual rocks assigned</p>'}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                },
                issues() {
                    const { issues, departments } = App.data;
                    const priorityColors = { 1: 'text-rose-400', 2: 'text-amber-400', 3: 'text-gray-400' };
                    const priorityBg = { 1: 'bg-rose-500/10 border-rose-500/30', 2: 'bg-amber-500/10 border-amber-500/30', 3: 'bg-gray-500/10 border-gray-500/30' };

                    // Group issues by department
                    const issuesByDept = {};
                    issues.forEach(issue => {
                        const dept = issue.department || 'unassigned';
                        if (!issuesByDept[dept]) issuesByDept[dept] = [];
                        issuesByDept[dept].push(issue);
                    });

                    return `
                        <div class="space-y-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-white">Company Issues List</h2>
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center space-x-2 text-sm">
                                        <span class="flex items-center"><span class="w-3 h-3 bg-rose-500 rounded-full mr-1"></span> Critical (${issues.filter(i => i.priority === 1).length})</span>
                                        <span class="flex items-center"><span class="w-3 h-3 bg-amber-500 rounded-full mr-1"></span> High (${issues.filter(i => i.priority === 2).length})</span>
                                        <span class="flex items-center"><span class="w-3 h-3 bg-gray-500 rounded-full mr-1"></span> Normal (${issues.filter(i => i.priority === 3).length})</span>
                                    </div>
                                    <button class="add-issue-btn bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700">Add Issue</button>
                                </div>
                            </div>

                            <!-- Issues by Department -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                ${Object.entries(issuesByDept).map(([deptKey, deptIssues]) => {
                                    const dept = departments[deptKey];
                                    return `
                                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                            <h3 class="font-semibold text-indigo-400 mb-3 flex justify-between items-center">
                                                ${dept?.name || deptKey}
                                                <span class="text-xs bg-gray-700 px-2 py-1 rounded">${deptIssues.length} issues</span>
                                            </h3>
                                            <ul class="space-y-2">
                                                ${deptIssues.sort((a,b) => a.priority - b.priority).map(issue => `
                                                    <li class="p-3 border rounded-lg ${priorityBg[issue.priority]}">
                                                        <p class="text-sm font-medium text-gray-200">${issue.title}</p>
                                                        <div class="flex justify-between items-center mt-2">
                                                            <span class="text-xs ${priorityColors[issue.priority]}">Priority ${issue.priority} • ${issue.age} days</span>
                                                            <div class="flex items-center space-x-1">
                                                                <button class="edit-issue-btn text-gray-400 hover:text-indigo-400 p-1" data-issue-id="${issue.id}">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                                                                </button>
                                                                <button class="delete-issue-btn text-gray-400 hover:text-red-400 p-1" data-issue-id="${issue.id}">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                },
                departments() {
                    return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${Object.keys(App.data.departments).map(key => {
                        const dept = App.data.departments[key];
                        const rockCount = Array.isArray(dept.rocks) ? dept.rocks.length : 0;
                        return `<a href="#departments/${key}" class="block bg-gray-800 border border-gray-700 p-6 rounded-lg shadow hover:border-indigo-500 transition-colors">
                                <h3 class="text-xl font-bold text-indigo-300">${dept.name}</h3>
                                <p class="text-gray-400 mt-1">Headed by: ${dept.head}</p>
                                <div class="mt-4 text-sm text-gray-500 space-y-1">
                                    <p>${dept.members.length} Team Members</p>
                                    <p>${rockCount} Rocks</p>
                                </div>
                            </a>`;
                    }).join('')}</div>`;
},
                rocks() {
                    const { companyRocks, departmentalRocks, individualRocks } = App.data;
                    const departmentRocks = departmentalRocks || App.data.departmentRocks;
                    const statusColors = { "On Track": "border-blue-500", "Off Track": "border-red-500", "Done": "border-green-500" };
                    const statusBg = { "On Track": "bg-blue-500/20 text-blue-300", "Off Track": "bg-red-500/20 text-red-300", "Done": "bg-green-500/20 text-green-300" };

                    return `
                        <div class="space-y-6 pb-24">
                            <!-- Company Rocks -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold text-white">Company Rocks - ${companyRocks[0]?.quarter || 'Q4 2025'}</h2>
                                    <button id="add-company-rock-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-500" data-rock-type="company">+ Add Rock</button>
                                </div>
                                <div class="grid gap-4">
                                    ${companyRocks.map(rock => `
                                        <div class="bg-gray-800 border-l-4 ${statusColors[rock.status]} rounded-r-lg p-4">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <p class="font-semibold text-lg text-white">${rock.title || rock.name}</p>
                                                    <p class="text-sm text-gray-400 mt-1">Owner: ${rock.owner}</p>
                                                    ${rock.notes ? `<p class="text-xs text-gray-500 mt-2">${rock.notes}</p>` : ''}
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="px-2 py-1 text-xs rounded-full ${statusBg[rock.status]}">${rock.status}</span>
                                                    ${rock.team ? `<span class="px-2 py-1 text-xs rounded-full bg-gray-700 text-gray-300">${rock.team}</span>` : ''}
                                                    <button class="edit-rock-btn text-gray-400 hover:text-indigo-400 ml-2" data-rock-id="${rock.id}" data-rock-type="company">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Department Rocks -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-white">Department Rocks</h2>
                                    <button id="add-dept-rock-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-500" data-rock-type="department">+ Add Dept Rock</button>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    ${Object.entries(departmentRocks || {}).map(([dept, rocks]) => `
                                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                            <h3 class="font-semibold text-indigo-400 mb-3">${App.data.departments[dept]?.name || dept}</h3>
                                            <div class="space-y-3">
                                                ${rocks.map(rock => `
                                                    <div class="border-l-4 ${statusColors[rock.status]} pl-3 relative group">
                                                        <p class="text-sm text-white">${rock.title || rock.name}</p>
                                                        <p class="text-xs text-gray-400">${rock.owner}</p>
                                                        <span class="inline-block mt-1 px-2 py-1 text-xs rounded ${statusBg[rock.status]}">${rock.status}</span>
                                                        <button class="edit-rock-btn absolute top-0 right-0 text-gray-400 hover:text-indigo-400 opacity-0 group-hover:opacity-100 transition-opacity" data-rock-id="${rock.id}" data-rock-type="department" data-dept="${dept}">
                                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Individual Rocks -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-white">Individual Rocks</h2>
                                    <button id="add-individual-rock-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-500" data-rock-type="individual">+ Add Individual Rock</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${(individualRocks || []).map(rock => `
                                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <p class="font-medium text-white">${rock.title || rock.name}</p>
                                                    <p class="text-sm text-gray-400 mt-1">${rock.employeeName || rock.owner} • ${App.data.departments[rock.department]?.name || rock.department || ''}</p>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="px-2 py-1 text-xs rounded-full ${statusBg[rock.status]}">${rock.status}</span>
                                                    <button class="edit-rock-btn text-gray-400 hover:text-indigo-400" data-rock-id="${rock.id}" data-rock-type="individual" data-owner="${rock.owner || rock.employeeName}">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                },
                data() {
                    const { scorecard, departmentalScorecards, departments } = App.data;

                    return `
                        <div class="space-y-6">
                            <!-- Company Scorecard -->
                            <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                                    <h2 class="text-2xl font-bold text-white">Company Scorecard</h2>
                                    <div class="flex gap-2">
                                        <button id="add-metric-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-500" data-scorecard-type="company">+ Add Metric</button>
                                        <button id="view-history-btn" class="bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600">View History</button>
                                        <button id="save-snapshot-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-500">Save Snapshot</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-gray-900/60">
                                            <tr>
                                                <th class="p-4 font-semibold text-gray-300">Metric</th>
                                                <th class="p-4 font-semibold text-gray-300">Goal</th>
                                                <th class="p-4 font-semibold text-gray-300">Actual</th>
                                                <th class="p-4 font-semibold text-gray-300">Trend (4 weeks)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${scorecard.map((item, index) => {
                                                const numGoal = parseFloat(String(item.goal).replace(/[^0-9.-]/g, '')) || 0;
                                                const numValue = parseFloat(String(item.value).replace(/[^0-9.-]/g, '')) || 0;
                                                const isTimeMetric = item.metric.toLowerCase().includes('time');
                                                const onTarget = isTimeMetric ? numValue <= numGoal : numValue >= numGoal;
                                                return `
                                                    <tr class="border-b border-gray-700 hover:bg-gray-900/40">
                                                        <td class="p-4 font-medium text-gray-200">${item.metric}</td>
                                                        <td class="p-4 text-gray-400">${item.goal}</td>
                                                        <td class="p-4">
                                                            <input type="text" class="scorecard-input bg-gray-900 border border-gray-700 rounded-md p-2 w-28 text-right text-gray-200" value="${item.value}" data-index="${index}" data-type="company">
                                                        </td>
                                                        <td class="p-4">
                                                            <div class="w-28 h-16">
                                                                <canvas class="scorecard-chart" data-trend='${JSON.stringify(item.trend)}' data-good="${onTarget}"></canvas>
                                                            </div>
                                                        </td>
                                                    </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Departmental Scorecards -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                ${Object.entries(departmentalScorecards || {}).map(([deptKey, deptScorecard]) => {
                                    const dept = departments[deptKey];
                                    return `
                                        <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg">
                                            <h3 class="text-lg font-semibold text-indigo-400 mb-3">${dept?.name || deptKey} Scorecard</h3>
                                            <div class="space-y-3">
                                                ${deptScorecard.map((item, idx) => {
                                                    const numGoal = parseFloat(String(item.goal).replace(/[^0-9.-]/g, '')) || 0;
                                                    const numValue = parseFloat(String(item.value).replace(/[^0-9.-]/g, '')) || 0;
                                                    const isTimeMetric = item.metric.toLowerCase().includes('time') || item.metric.toLowerCase().includes('days');
                                                    const onTarget = isTimeMetric ? numValue <= numGoal : numValue >= numGoal;
                                                    return `
                                                        <div class="border-l-4 ${onTarget ? 'border-emerald-500' : 'border-rose-500'} pl-3">
                                                            <p class="text-xs text-gray-400">${item.metric}</p>
                                                            <div class="flex justify-between items-center">
                                                                <input type="text" class="dept-scorecard-input bg-gray-900 border border-gray-700 rounded p-1 w-20 text-sm text-right text-gray-200" value="${item.value}" data-dept="${deptKey}" data-index="${idx}">
                                                                <span class="text-xs text-gray-500">Goal: ${item.goal}</span>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                },
                integrations() {
                    return App.integrations();
                },

                l10() {
                    return `<div class="flex border-b border-gray-700 mb-4"><button id="l10-tab-live" class="px-4 py-2 font-semibold border-b-2 border-indigo-500 text-indigo-400">Live Meeting</button><button id="l10-tab-history" class="px-4 py-2 font-semibold text-gray-500 hover:text-gray-300">History & AI Insights</button></div><div id="l10-content"></div>`;
                },
                departmentDetail(deptKey) {
                    const dept = App.data.departments[deptKey];
                    if (!dept) return `<p class="text-gray-400">Department not found.</p>`;

                    const deptRocks = App.data.departmentRocks[deptKey] || [];
                    const deptIssues = App.data.issues.filter(i => i.department === deptKey);
                    const deptIndividualRocks = App.data.individualRocks.filter(r => r.department === deptKey);
                    const deptScorecard = App.data.departmentalScorecards[deptKey] || [];
                    const deptMeetings = App.data.meetingHistory.filter(m => m.department === deptKey).slice(0, 3);
                    const deptTodos = App.data.todos.filter(t => t.department === deptKey && !t.completed);

                    const getNumber = (value) => {
                        const parsed = parseFloat(String(value ?? '').replace(/[^0-9.-]/g, ''));
                        return Number.isFinite(parsed) ? parsed : 0;
                    };

                    return `
                        <div><a href="#departments" class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block">&larr; Back to all departments</a></div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <!-- Department Scorecard -->
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Department Scorecard</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        ${deptScorecard.map(item => {
                                            const goal = getNumber(item.goal);
                                            const value = getNumber(item.value);
                                            const isTimeMetric = item.metric.toLowerCase().includes('time') || item.metric.toLowerCase().includes('days');
                                            const onTarget = isTimeMetric ? value <= goal : value >= goal;
                                            return `
                                                <div class="border ${onTarget ? 'border-emerald-500/30 bg-emerald-500/10' : 'border-rose-500/40 bg-rose-500/10'} rounded-lg p-3">
                                                    <p class="text-sm text-gray-300">${item.metric}</p>
                                                    <p class="text-xl font-bold text-white">${item.value}</p>
                                                    <p class="text-xs text-gray-400">Goal: ${item.goal}</p>
                                                    <div class="mt-2 h-8 w-full">
                                                        <canvas class="scorecard-chart" data-trend='${JSON.stringify(item.trend || [])}' data-good="${onTarget}"></canvas>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('') || '<p class="text-gray-500">No scorecard metrics defined.</p>'}
                                    </div>
                                </div>

                                <!-- Department Rocks -->
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Department Rocks</h3>
                                    <ul class="space-y-3">
                                        ${deptRocks.map(rock => `
                                            <li class="p-3 border rounded-lg flex justify-between items-center ${rock.status === 'Off Track' ? 'border-rose-500/40 bg-rose-500/10' : rock.status === 'Done' ? 'border-indigo-500/30 bg-indigo-500/10' : 'border-emerald-500/30 bg-emerald-500/10'}">
                                                <div>
                                                    <p class="font-semibold text-gray-100">${rock.title}</p>
                                                    <p class="text-xs text-gray-400">${rock.owner}</p>
                                                </div>
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-900/60 text-gray-200">${rock.status}</span>
                                            </li>
                                        `).join('') || '<li class="text-gray-500">No department rocks assigned.</li>'}
                                    </ul>
                                </div>

                                <!-- Individual Rocks -->
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Individual Rocks</h3>
                                    <ul class="space-y-3">
                                        ${deptIndividualRocks.map(rock => `
                                            <li class="p-3 border rounded-lg ${rock.status === 'Off Track' ? 'border-rose-500/40 bg-rose-500/10' : rock.status === 'Done' ? 'border-indigo-500/30 bg-indigo-500/10' : 'border-emerald-500/30 bg-emerald-500/10'}">
                                                <p class="font-medium text-gray-100">${rock.title}</p>
                                                <div class="flex justify-between items-center mt-1">
                                                    <p class="text-xs text-gray-400">${rock.employeeName}</p>
                                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-900/60 text-gray-200">${rock.status}</span>
                                                </div>
                                            </li>
                                        `).join('') || '<li class="text-gray-500">No individual rocks in this department.</li>'}
                                    </ul>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <!-- Team -->
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Team</h3>
                                    <ul class="space-y-2">
                                        <li class="font-semibold text-gray-100">${dept.head} <span class="text-xs text-gray-400">(Head)</span></li>
                                        ${(dept.members || []).map((member, idx) => {
                                            const empId = dept.memberIds[idx];
                                            const emp = App.data.employees.find(e => e.id === empId);
                                            return `<li class="text-gray-300">${member} ${emp ? `<span class="text-xs text-gray-500">- ${emp.role}</span>` : ''}</li>`;
                                        }).join('')}
                                    </ul>
                                </div>

                                <!-- Department Issues -->
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Issues</h3>
                                    <ul class="space-y-2">
                                        ${deptIssues.map(issue => `
                                            <li class="p-2 bg-gray-900/50 rounded">
                                                <p class="text-sm text-gray-200">${issue.title}</p>
                                                <p class="text-xs text-gray-400 mt-1">Priority ${issue.priority} • ${issue.age} days old</p>
                                            </li>
                                        `).join('') || '<li class="text-gray-500">No issues reported.</li>'}
                                    </ul>
                                </div>

                                <!-- Active To-Dos -->
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Active To-Dos</h3>
                                    <ul class="space-y-2">
                                        ${deptTodos.map(todo => `
                                            <li class="p-2 bg-gray-900/50 rounded">
                                                <p class="text-sm text-gray-200">${todo.task}</p>
                                                <p class="text-xs text-gray-400 mt-1">${todo.assignee} • Due ${todo.dueDate}</p>
                                            </li>
                                        `).join('') || '<li class="text-gray-500">No active to-dos.</li>'}
                                    </ul>
                                </div>

                                <!-- Recent Meetings -->
                                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-white mb-4">Recent L10 Meetings</h3>
                                    <ul class="space-y-2">
                                        ${deptMeetings.map(meeting => `
                                            <li class="p-2 bg-gray-900/50 rounded">
                                                <p class="text-sm font-medium text-gray-200">${meeting.date}</p>
                                                <p class="text-xs text-gray-400 mt-1">Rating: ${meeting.rating}/10</p>
                                                ${meeting.transcriptionUrl ? `<a href="${meeting.transcriptionUrl}" target="_blank" class="text-xs text-indigo-400 hover:underline">View Recording</a>` : ''}
                                            </li>
                                        `).join('') || '<li class="text-gray-500">No recent meetings.</li>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },
            
            renderCharts() {
                const salesCanvas = document.getElementById('salesChart');
                if (salesCanvas && App.data.scorecard?.trend) {
                    const chart = new Chart(salesCanvas, {
                        type: 'line',
                        data: {
                            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                            datasets: [{
                                label: 'Weekly Sales ($)',
                                data: App.data.scorecard.trend.map(value => value * 1000),
                                borderColor: '#6366F1',
                                backgroundColor: 'rgba(99, 102, 241, 0.15)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(148, 163, 184, 0.15)' } },
                                y: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(148, 163, 184, 0.15)' } }
                            }
                        }
                    });
                    this._charts.push(chart);
                }

                document.querySelectorAll('.scorecard-chart').forEach(canvas => {
                    const trendData = JSON.parse(canvas.dataset.trend || '[]');
                    const isGood = canvas.dataset.good === 'true';
                    const chart = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: Array(trendData.length).fill(''),
                            datasets: [{
                                data: trendData,
                                borderColor: isGood ? '#34D399' : '#F87171',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                    this._charts.push(chart);
                });
            },

            initL10() {
                const liveTab = document.getElementById('l10-tab-live');
                const historyTab = document.getElementById('l10-tab-history');
                const contentContainer = document.getElementById('l10-content');
                const deptSelect = document.getElementById('l10-department-select');
                let timerInterval;
                let currentStep = 0;
                let currentMeetingData = {
                    department: 'company',
                    segueNotes: '',
                    cascadeMessage: '',
                    rating: null,
                    completedTodos: [],
                    createdTodos: []
                };

                // Handle department selection
                if (deptSelect) {
                    deptSelect.addEventListener('change', (e) => {
                        App.currentL10Department = e.target.value;
                        currentMeetingData.department = e.target.value;
                        if (currentStep > 0) {
                            renderL10Step();
                        }
                    });
                }

                const addIssue = (title, priority = 3) => {
                    if (!title || !title.trim()) return;
                    const newIssue = { id: Date.now(), title: title.trim(), priority, age: 0 };
                    App.data.l10Data.meetingIssues.push(newIssue);
                    App.data.l10Data.meetingIssues.sort((a, b) => a.priority - b.priority);
                    Persistence.save(App.data);
                    renderL10Step();
                };

                const addToDo = (task, assignee) => {
                    if (!task || !task.trim() || !assignee || !assignee.trim()) return;
                    const newTodo = { id: Date.now(), task: task.trim(), assignee: assignee.trim(), dueDate: 'Next Week', completed: false };
                    App.data.l10Data.currentToDos.push(newTodo);
                    Persistence.save(App.data);
                    renderL10Step();
                };

                const L10_CONTENT = {
                    segue: () => `
                        <div class="space-y-4">
                            <h4 class="font-bold text-gray-100 mb-2">Good News</h4>
                            <p class="text-gray-400 mb-4">Each team member shares one personal and one business win from the past week.</p>

                            <!-- Google Meet Sync Status -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="relative">
                                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                            <div class="absolute top-0 left-0 w-3 h-3 bg-green-500 rounded-full animate-ping"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-300">Google Meet Connected</span>
                                        <span class="text-xs text-gray-500">Last sync: 2 mins ago</span>
                                    </div>
                                    <button id="sync-meet-btn" class="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded-lg text-sm">
                                        <svg class="w-4 h-4 animate-spin hidden" id="sync-spinner" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Sync Now</span>
                                    </button>
                                </div>

                                <!-- Meeting Recording Info -->
                                <div class="bg-gray-800 rounded-lg p-3">
                                    <div class="flex items-start space-x-3">
                                        <div class="bg-red-600 rounded-lg p-2">
                                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-200">Meeting Recording Available</p>
                                            <p class="text-xs text-gray-400">Duration: 1:32:45 • 8 participants</p>
                                            <div class="flex space-x-2 mt-2">
                                                <button class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded">View Recording</button>
                                                <button class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded">Download Transcript</button>
                                                <button class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 rounded">Auto-Generate Notes</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <textarea class="w-full p-3 border border-gray-700 rounded bg-gray-900 text-gray-100 focus:outline-none focus:border-indigo-500" rows="4" placeholder="Capture notes here..."></textarea>
                        </div>
                    `,
                    scorecard: () => `${App.data.scorecard.map((item, index) => {
                        const goal = parseFloat(String(item.goal).replace(/[^0-9.-]/g, '')) || 0;
                        const value = parseFloat(String(item.value).replace(/[^0-9.-]/g, '')) || 0;
                        const isTimeMetric = item.metric.toLowerCase().includes('time');
                        const onTarget = isTimeMetric ? value <= goal : value >= goal;
                        return `<div class="flex flex-col sm:flex-row justify-between sm:items-center p-3 rounded border ${onTarget ? 'border-emerald-500/30 bg-emerald-500/10' : 'border-rose-500/40 bg-rose-500/10'}">
                                    <span class="font-medium text-gray-100 mb-2 sm:mb-0">${item.metric}</span>
                                    <div class="flex items-center space-x-3">
                                        <span class="text-sm text-gray-400">Goal: ${item.goal}</span>
                                        <input type="text" value="${item.value}" class="w-24 p-2 border border-gray-700 rounded bg-gray-900 text-right text-gray-100 focus:outline-none focus:border-indigo-500" data-metric-index="${index}">
                                        ${onTarget ? '' : `<button class="add-to-ids-btn text-xs bg-yellow-500 text-gray-900 px-2 py-1 rounded hover:bg-yellow-400" data-issue-title="${item.metric} is off track">Add to IDS</button>`}
                                    </div>
                                </div>`;
                    }).join('')}`,
                    rockReview: () => `${App.data.companyRocks.map(rock => `<div class="flex justify-between items-center p-3 rounded border ${rock.status === 'Off Track' ? 'border-rose-500/40 bg-rose-500/10' : rock.status === 'Done' ? 'border-indigo-500/30 bg-indigo-500/10' : 'border-emerald-500/30 bg-emerald-500/10'}">
                                <div>
                                    <p class="font-semibold text-gray-100">${rock.title}</p>
                                    <p class="text-xs text-gray-400">${rock.owner}</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer toggle-checkbox" data-rock-id="${rock.id}" ${rock.status === 'On Track' ? 'checked' : ''}>
                                    <div class="w-12 h-6 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 transition-colors"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-6"></div>
                                </label>
                            </div>`).join('')}`,
                    headlines: () => `
                        <div class="space-y-6">
                            <!-- Customer Headlines Table -->
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-gray-100">Customer Headlines</h4>
                                    <button id="add-customer-headline" class="text-sm bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded">+ Add Row</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-900/60">
                                            <tr>
                                                <th class="p-2 text-left text-gray-400">Customer</th>
                                                <th class="p-2 text-left text-gray-400">Issue/Win</th>
                                                <th class="p-2 text-left text-gray-400">Priority</th>
                                                <th class="p-2 text-left text-gray-400">Department</th>
                                                <th class="p-2 text-center text-gray-400">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customer-headlines-table">
                                            <tr class="border-b border-gray-700">
                                                <td class="p-2"><input type="text" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-100" placeholder="Customer name..."></td>
                                                <td class="p-2"><input type="text" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-100" placeholder="Issue or win..."></td>
                                                <td class="p-2">
                                                    <select class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-100">
                                                        <option>Low</option>
                                                        <option>Medium</option>
                                                        <option>High</option>
                                                    </select>
                                                </td>
                                                <td class="p-2">
                                                    <select class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-100">
                                                        <option>Sales</option>
                                                        <option>Support</option>
                                                        <option>Product</option>
                                                        <option>Engineering</option>
                                                    </select>
                                                </td>
                                                <td class="p-2 text-center">
                                                    <button class="customer-to-ids text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 rounded">Add to IDS</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Employee Headlines Table -->
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-gray-100">Employee Headlines</h4>
                                    <button id="add-employee-headline" class="text-sm bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded">+ Add Row</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-900/60">
                                            <tr>
                                                <th class="p-2 text-left text-gray-400">Employee</th>
                                                <th class="p-2 text-left text-gray-400">Department</th>
                                                <th class="p-2 text-left text-gray-400">Headline</th>
                                                <th class="p-2 text-left text-gray-400">Type</th>
                                                <th class="p-2 text-center text-gray-400">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="employee-headlines-table">
                                            <tr class="border-b border-gray-700">
                                                <td class="p-2"><input type="text" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-100" placeholder="Employee name..."></td>
                                                <td class="p-2">
                                                    <select class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-100">
                                                        <option>Engineering</option>
                                                        <option>Marketing</option>
                                                        <option>Sales</option>
                                                        <option>Operations</option>
                                                    </select>
                                                </td>
                                                <td class="p-2"><input type="text" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-100" placeholder="Headline..."></td>
                                                <td class="p-2">
                                                    <select class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-gray-100">
                                                        <option>Win</option>
                                                        <option>Issue</option>
                                                        <option>Update</option>
                                                    </select>
                                                </td>
                                                <td class="p-2 text-center">
                                                    <button class="employee-to-ids text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 rounded">Add to IDS</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `,
                    toDoList: () => {
                        const openTodos = App.data.l10Data.lastWeeksToDos.filter(todo => !todo.completed);
                        return `<h4 class="font-bold text-gray-100 mb-2">To-Do List</h4>
                                <p class="text-gray-400 mb-4">Review last week's commitments. Goal is 90% completion.</p>
                                <div id="last-week-todos">
                                    <h5 class="font-semibold text-sm text-gray-400 mb-2">From Last Week</h5>
                                    ${openTodos.length ? openTodos.map(todo => `<div class="flex items-center justify-between p-3 border border-gray-700 bg-gray-900/60 rounded mb-2 transition">
                                                <label class="flex items-center space-x-3 text-gray-100">
                                                    <input type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-800" data-todo-id="${todo.id}">
                                                    <span>
                                                        <p>${todo.task}</p>
                                                        <p class="text-xs text-gray-400">${todo.assignee} &ndash; Due ${todo.dueDate}</p>
                                                    </span>
                                                </label>
                                            </div>`).join('') : '<p class="text-gray-500 text-sm">All done!</p>'}
                                </div>
                                <div id="current-todos" class="mt-4">
                                    <h5 class="font-semibold text-sm text-gray-400 mb-2">New To-Dos (This Meeting)</h5>
                                    ${App.data.l10Data.currentToDos.length ? App.data.l10Data.currentToDos.map(todo => `<div class="flex items-center justify-between p-3 border border-amber-500/40 bg-amber-500/10 rounded mb-2">
                                                <div>
                                                    <p class="text-gray-100">${todo.task}</p>
                                                    <p class="text-xs text-gray-400">${todo.assignee}</p>
                                                </div>
                                                <button class="delete-todo-btn text-rose-400 hover:text-rose-300 text-xl font-bold p-1" data-todo-id="${todo.id}">&times;</button>
                                            </div>`).join('') : '<p class="text-gray-500 text-sm">No new to-dos yet.</p>'}
                                </div>`;
                    },
                    ids: () => `<h4 class="font-bold text-gray-100 mb-2">Identify, Discuss, Solve (IDS)</h4><p class="text-gray-400 mb-4">Work the list in priority order. Convert decisions into to-dos as needed.</p><div id="issues-list" class="space-y-3 mb-4">${App.data.l10Data.meetingIssues.map(issue => `<div class="p-4 border border-gray-700 rounded-lg bg-gray-900/80 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <p class="font-semibold text-gray-100 mb-3 sm:mb-0">${issue.priority}. ${issue.title}</p>
                                <button class="add-todo-from-ids-btn text-xs bg-emerald-500 text-gray-900 px-3 py-1 rounded hover:bg-emerald-400 self-start sm:self-center" data-issue-title="${issue.title}">Add a To-Do</button>
                            </div>`).join('') || '<p class="text-gray-500">No issues on the board.</p>'}</div><div class="flex space-x-3"><input id="manual-issue-input" type="text" class="flex-grow p-3 border border-gray-700 rounded bg-gray-900 text-gray-100 focus:outline-none focus:border-indigo-500" placeholder="Manually add a new issue..."><button id="add-manual-issue-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-500">Add</button></div>`,
                    conclude: () => `<h4 class="font-bold text-gray-100 mb-2">Conclude</h4><p class="text-gray-400 mb-4">Recap the new to-dos, confirm cascading messages, and rate the meeting.</p><p class="font-semibold text-gray-100">New To-Dos Created: ${App.data.l10Data.currentToDos.length}</p><label class="block mt-3 text-sm text-gray-300">Cascading Message<textarea class="w-full mt-2 p-3 border border-gray-700 rounded bg-gray-900 text-gray-100 focus:outline-none focus:border-indigo-500" rows="3" placeholder="Example: Tech team is prioritizing the Shopify sync fix."></textarea></label><p class="mt-4 text-center text-2xl font-bold text-indigo-300">Meeting Rating: ___ / 10</p>`
                };

                const steps = [
                    { title: 'Welcome', duration: 0, content: () => `<p class="text-center text-gray-300">This is a guided simulation of a 90 minute Level 10 Meeting.</p><button id="start-l10" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-semibold">Start Meeting</button>` },
                    { title: 'Segue', duration: 300, content: L10_CONTENT.segue },
                    { title: 'Scorecard', duration: 300, content: () => `<h4 class="font-bold text-gray-100 mb-4">Scorecard Review</h4>${L10_CONTENT.scorecard()}` },
                    { title: 'Rock Review', duration: 300, content: () => `<h4 class="font-bold text-gray-100 mb-4">Rock Review</h4>${L10_CONTENT.rockReview()}` },
                    { title: 'Headlines', duration: 300, content: L10_CONTENT.headlines },
                    { title: 'To-Do List', duration: 300, content: L10_CONTENT.toDoList },
                    { title: 'IDS', duration: 3600, content: L10_CONTENT.ids },
                    { title: 'Conclude', duration: 300, content: L10_CONTENT.conclude },
                ];

                const startTimer = (duration) => {
                    if (timerInterval) clearInterval(timerInterval);
                    const timerEl = document.getElementById('timer');
                    if (!timerEl) return;
                    if (!duration) { timerEl.textContent = '00:00'; return; }
                    let time = duration;
                    timerInterval = setInterval(() => {
                        const minutes = Math.floor(time / 60);
                        const seconds = time % 60;
                        timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        if (time-- <= 0) clearInterval(timerInterval);
                    }, 1000);
                };

                const renderL10Step = () => {
                    const step = steps[currentStep];
                    contentContainer.innerHTML = `
                        <div class="bg-gray-900 border border-gray-800 p-6 sm:p-8 rounded-xl shadow-inner space-y-6">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl sm:text-2xl font-bold text-white">${step.title}</h3>
                                <p id="timer" class="text-xl sm:text-2xl font-bold text-indigo-400 l10-timer">00:00</p>
                            </div>
                            <div class="space-y-4 text-sm sm:text-base">${step.content()}</div>
                            <div class="flex justify-between">
                                <button id="prev-step" class="px-4 py-2 rounded-lg font-semibold bg-gray-800 text-gray-300 hover:bg-gray-700 disabled:opacity-40 disabled:hover:bg-gray-800" ${currentStep === 0 ? 'disabled' : ''}>Previous</button>
                                <button id="next-step" class="px-4 py-2 rounded-lg font-semibold bg-indigo-600 text-white hover:bg-indigo-500">${currentStep === steps.length - 1 ? 'Finish Meeting' : 'Next'}</button>
                            </div>
                        </div>`;
                    startTimer(step.duration);
                };

                const showLiveMeeting = () => {
                    liveTab.classList.add('border-indigo-500', 'text-indigo-400');
                    liveTab.classList.remove('text-gray-500');
                    historyTab.classList.remove('border-indigo-500', 'text-indigo-400');
                    historyTab.classList.add('text-gray-500');
                    renderL10Step();
                };

                const showHistory = () => {
                    historyTab.classList.add('border-indigo-500', 'text-indigo-400');
                    historyTab.classList.remove('text-gray-500');
                    liveTab.classList.remove('border-indigo-500', 'text-indigo-400');
                    liveTab.classList.add('text-gray-500');
                    const historyMarkup = App.data.meetingHistory.map(meeting => `<li class="p-3 border border-gray-800 bg-gray-900/70 rounded-lg flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-100">L10 Meeting - ${meeting.date}</p>
                                <p class="text-xs text-gray-400">Rating: ${meeting.rating}/10 &amp;bull; Key Topics: ${meeting.keyTopics.join(', ')}</p>
                            </div>
                            ${meeting.link ? `<a href="${meeting.link}" class="text-indigo-300 hover:underline text-xs">View</a>` : ''}
                        </li>`).join('') || '<li class="text-gray-500">No meeting history recorded.</li>';

                    contentContainer.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">Meeting History</h3>
                            <ul class="space-y-3">${historyMarkup}</ul>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">AI Sentiment Analysis</h3>
                            <p class="text-sm text-gray-400 mb-4">Sentiment scores based on the last several meetings.</p>
                            <canvas id="sentimentChart"></canvas>
                        </div>
                    </div>`;

                    const chartEl = document.getElementById('sentimentChart');
                    if (chartEl && App.data.meetingHistory.length) {
                        new Chart(chartEl, {
                            type: 'line',
                            data: {
                                labels: App.data.meetingHistory.map(m => m.date).reverse(),
                                datasets: [{
                                    label: 'Meeting Sentiment Score',
                                    data: App.data.meetingHistory.map(m => m.sentiment).reverse(),
                                    borderColor: '#6366F1',
                                    backgroundColor: 'rgba(99, 102, 241, 0.15)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 3
                                }]
                            },
                            options: {
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(148, 163, 184, 0.15)' } },
                                    y: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(148, 163, 184, 0.15)' }, suggestedMin: 0, suggestedMax: 100 }
                                }
                            }
                        });
                    }
                };

                liveTab.addEventListener('click', () => { currentStep = 0; showLiveMeeting(); });
                historyTab.addEventListener('click', showHistory);

                contentContainer.addEventListener('click', (event) => {
                    const target = event.target;
                    if (target.id === 'start-l10' || target.id === 'next-step') {
                        if (currentStep < steps.length - 1) {
                            currentStep += 1;
                            renderL10Step();
                        } else {
                            alert('Meeting finished! Great work.');
                        }
                    }
                    if (target.id === 'prev-step') {
                        if (currentStep > 0) {
                            currentStep -= 1;
                            renderL10Step();
                        }
                    }
                    if (target.classList.contains('add-to-ids-btn')) {
                        addIssue(target.dataset.issueTitle, 1);
                    }
                    if (target.classList.contains('add-headline-btn')) {
                        const sourceId = target.dataset.source;
                        const textarea = document.getElementById(sourceId);
                        if (textarea && textarea.value.trim()) {
                            addIssue(textarea.value.trim());
                            textarea.value = '';
                        }
                    }
                    if (target.id === 'add-manual-issue-btn') {
                        const input = document.getElementById('manual-issue-input');
                        if (input && input.value.trim()) {
                            addIssue(input.value.trim(), 3);
                            input.value = '';
                        }
                    }
                    if (target.classList.contains('add-todo-from-ids-btn')) {
                        const task = prompt('Enter To-Do task:', target.dataset.issueTitle || '');
                        const assignee = task ? prompt('Assign to:', 'Asfand Y.') : null;
                        if (task && assignee) addToDo(task, assignee);
                    }
                    if (target.classList.contains('delete-todo-btn')) {
                        const todoId = parseInt(target.dataset.todoId, 10);
                        App.data.l10Data.currentToDos = App.data.l10Data.currentToDos.filter(todo => todo.id !== todoId);
                        Persistence.save(App.data);
                        renderL10Step();
                    }
                });

                contentContainer.addEventListener('change', (event) => {
                    const target = event.target;
                    if (target.classList.contains('toggle-checkbox')) {
                        const rockId = parseInt(target.dataset.rockId, 10);
                        const rock = App.data.companyRocks.find(item => item.id === rockId);
                        if (rock) {
                            rock.status = target.checked ? 'On Track' : 'Off Track';
                            Persistence.save(App.data);
                            renderL10Step();
                        }
                    }
                    if (target.matches('input[type="checkbox"][data-todo-id]')) {
                        const todoId = parseInt(target.dataset.todoId, 10);
                        const todo = App.data.l10Data.lastWeeksToDos.find(item => item.id === todoId);
                        if (todo) {
                            todo.completed = target.checked;
                            Persistence.save(App.data);
                            target.closest('div.flex').style.opacity = '0';
                            setTimeout(() => renderL10Step(), 300);
                        }
                    }
                });

                contentContainer.addEventListener('input', (event) => {
                    const target = event.target;
                    if (target.matches('input[data-metric-index]')) {
                        const index = parseInt(target.dataset.metricIndex, 10);
                        if (App.data.scorecard[index]) {
                            App.data.scorecard[index].value = target.value;
                            Persistence.save(App.data);
                        }
                    }
                });

                showLiveMeeting();
            },

            integrations() {
                return `
                    <div class="space-y-6">
                        <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg">
                            <h2 class="text-2xl font-bold text-white mb-6">Integration Dashboard</h2>

                            <!-- Live Status Bar -->
                            <div class="bg-gray-900 rounded-lg p-4 mb-6 flex items-center justify-between">
                                <div class="flex items-center space-x-6">
                                    <div class="flex items-center space-x-2">
                                        <div class="relative">
                                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                            <div class="absolute top-0 left-0 w-3 h-3 bg-green-500 rounded-full animate-ping"></div>
                                        </div>
                                        <span class="text-sm text-gray-300">All Systems Operational</span>
                                    </div>
                                    <div class="text-xs text-gray-500">Last check: 30 seconds ago</div>
                                </div>
                                <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm">Run Full Sync</button>
                            </div>

                            <!-- Integration Cards Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Google Meet Card -->
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-5">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold text-white">Google Meet</h3>
                                                <p class="text-xs text-green-400">Connected</p>
                                            </div>
                                        </div>
                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    </div>
                                    <div class="space-y-2 text-xs text-gray-400">
                                        <div class="flex justify-between">
                                            <span>Last Sync:</span>
                                            <span class="text-gray-300">2 mins ago</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Meetings Synced:</span>
                                            <span class="text-gray-300">142</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Transcripts:</span>
                                            <span class="text-gray-300">89 available</span>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex space-x-2">
                                        <button class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1 rounded text-xs">Settings</button>
                                        <button class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded text-xs google-meet-sync">Sync Now</button>
                                    </div>
                                </div>

                                <!-- Webhook Card -->
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-5">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold text-white">Webhooks</h3>
                                                <p class="text-xs text-green-400">3 Active</p>
                                            </div>
                                        </div>
                                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                    </div>
                                    <div class="space-y-2 text-xs text-gray-400">
                                        <div class="flex justify-between">
                                            <span>Events Today:</span>
                                            <span class="text-gray-300">247</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Success Rate:</span>
                                            <span class="text-green-400">99.8%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Avg Response:</span>
                                            <span class="text-gray-300">120ms</span>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex space-x-2">
                                        <button class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1 rounded text-xs">View Logs</button>
                                        <button class="flex-1 bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded text-xs simulate-webhook">Test Hook</button>
                                    </div>
                                </div>

                                <!-- Other integration cards remain the same... -->
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
```

---

=== UNIVERSAL_FOUNDATION ===
---

# UNIVERSAL PROJECT SCAFFOLD PROMPT (ADAPTIVE, NO EXPERIMENTS)

**System intent**
You are a senior full-stack engineer. Create a production-ready Next.js application that follows the exact foundation and conventions below. Do not use experimental features. Tailwind v3.4 only. Recharts for charts. Given the input anatomy and theme, normalize them to this guide and resolve conflicts in favor of the Universal Foundation.

## INPUT BLOCKS

### [Anatomy]

*   Global Layout
    *   Sidebar: dark, left, collapsible on mobile, persistent on desktop.
    *   Header bar: refresh button, live update status dot, user avatar with name/role.
    *   Main content: dynamic renderer for hash routes.
    *   Modals: reusable for Rocks and Employees create/edit.
*   Pages (hash routing)
    *   `#dashboard`: AI Analyst summary; company scorecards; Rocks overview; cross-org issues, todos, priorities.
    *   `#vto`: editable EOS document (core values, focus, 10-year target, marketing strategy, 3-year picture, 1-year plan).
    *   `#departments`: grid of departments (head, members, rocks count).
    *   `#departments/{id}`: dept scorecard, rocks, member rocks, open issues/todos, recent L10 with recording links.
    *   `#people`: accountability chart; employee directory.
    *   `#data`: company metrics and historical charts.
    *   `#issues`: list with priority/age; add/edit.
    *   `#rocks`: company/department/individual rocks; add via modal.
    *   `#l10`: tabs for Live Meeting and History & AI Insights (summaries, ratings, recordings).
    *   `#integrations`: placeholder calling `App.integrations()`.
*   Features
    *   AI summaries (dashboard analyst, meeting insights).
    *   Live updates indicator and manual refresh.
    *   Charts for scorecards and trends.
    *   Modals for CRUD.
    *   Department drilldowns.
    *   Accountability chart.
*   Data Model
    *   Scorecard metrics; Rocks (company/department/individual); Issues; Todos; Meetings (L10) with date, rating, sentiment, recordings; Departments; Employees.

### [Theme Design Guide] → to be translated into Tailwind v3.4 tokens

*   Colors
    *   Backgrounds: body `#111827` (gray-900), sidebar gray-950, cards/modals gray-800, inputs gray-900.
    *   Accent: indigo-600 primary; hover indigo-500; active nav indigo-600.
    *   Text: white/gray-100 primary; gray-300/200 secondary; muted gray-400/500/600; links indigo-400 hover indigo-300.
    *   Status: success green-600/300/400; warning yellow-500/300, amber-600; error red-600/400/300; info blue-600/300.
*   Typography
    *   Inter font; sizes: titles 3xl, sections 2xl, subsections xl, body sm, labels xs; weights: extra-bold logo, bold headers, semibold subheaders, medium emphasis, normal body.
*   Layout
    *   Dashboard grids: `grid grid-cols-1 xl:grid-cols-3 gap-6`; metrics grids; card grids.
    *   Spacing: page `p-4 sm:p-6`, card `p-6`, sections `space-y-6`.
*   Components
    *   Card styles: gray-800 with gray-700 border; elevated variant with shadow.
    *   Buttons: primary indigo, secondary gray, danger red, ghost muted.
    *   Inputs: gray-900 with gray-700 border, focus indigo-500.
    *   Tables: dark header, gray separators.
*   Interactions
    *   Hover/focus transitions; status indicators with ping; subtle shadows; z-index: sidebar 30, modals 50, overlay 20.

### [Project Needs]

*   Data persistence: yes (Postgres)
*   Auth: email magic link
*   Realtime: live updates indicator (SSE)
*   AI: dashboard analyst + meeting insights
*   Charts: dashboards and department scorecards (Recharts)
*   Emails: transactional (magic link; meeting recap optional)
*   Background jobs: optional later (not required for MVP)
*   File uploads: not required for MVP (recordings stored as URLs)

---

## UNIVERSAL FOUNDATION (always include, no substitutions)

*   Package manager: **pnpm**
*   Framework: **`next@15.5.x`**
*   React: **`react@19.1.x`**, **`react-dom@19.1.x`**
*   Language: **`typescript@5.6.x`**
*   CSS: **`tailwindcss@3.4.x`**, **`postcss@8.5.x`**, **`autoprefixer@10.4.x`**
*   Lint/format: **`eslint@9.x`**, **`eslint-config-next@15.5.x`**, **`prettier@3.x`**
*   Icons: **`lucide-react@0.544.0`**
*   Forms & validation: **`react-hook-form@7.62.x`**, **`@hookform/resolvers@5.2.x`**, **`zod@3.23.x`**
*   RPC: **`@trpc/server@11.x`**, **`@trpc/react-query@11.x`**
*   Client data fetching & cache: **`@tanstack/react-query@5.x`**
*   Env safety: **`envsafe@3.x`** with Zod
*   Testing: **`vitest@2.x`**, **`@testing-library/react@16.x`**, **`@testing-library/jest-dom@6.x`**, **`msw@2.x`**
*   E2E: **`@playwright/test@1.48.x`**
*   Observability: **`@sentry/nextjs@8.x`**
*   Charts: **`recharts@3.1.x`**
*   Hash routing: implemented via a small client router layered on the Next App Router.

**Scripts (exact)**

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "prisma generate && next build",
    "start": "next start",
    "lint": "eslint .",
    "format": "prettier -w .",
    "typecheck": "tsc --noEmit",
    "test": "vitest run",
    "e2e": "playwright test"
  }
}
```

**Directory structure**

```
/src
  /app
    /(public)
      /auth
        sign-in/page.tsx
        sign-out/page.tsx
    /api/trpc/[trpc]/route.ts
    /api/sse/route.ts
    layout.tsx
    page.tsx
  /components
    ui/
    layout/
      Sidebar.tsx
      HeaderBar.tsx
      HashRouter.tsx
      Modal.tsx
    charts/
      Line.tsx
      Spark.tsx
  /features
    dashboard/
    vto/
    departments/
    department-detail/
    people/
    data/
    issues/
    rocks/
    l10/
    integrations/
  /server
    db.ts
    auth.ts
    trpc.ts
    routers/
      index.ts
      dashboard.ts
      vto.ts
      departments.ts
      people.ts
      data.ts
      issues.ts
      rocks.ts
      l10.ts
    rbac/
      roles.ts
      guards.ts
  /lib
    env.ts
    email/
      send.ts
      templates/
        MagicLinkEmail.tsx
    ai/
      summarize.ts
      meetingInsights.ts
    utils/
  /styles
    globals.css
/prisma
  schema.prisma
```

**Coding standards**

*   TypeScript strict; no `any`.
*   Server logic in Route Handlers or tRPC procedures only.
*   Zod-validate all external inputs.
*   RBAC checks on server only.
*   Use `@/*` import alias.
*   No experimental flags, no CDN script tags.

---

## NORMALIZATION RULES

1.  **Layout**: Always render Sidebar, HeaderBar, Main, and a shared Modal component. Sidebar collapses on mobile, fixed on desktop.
2.  **Navigation**: Implement `HashRouter.tsx` that maps `#dashboard`, `#vto`, `#departments`, `#departments/{id}`, `#people`, `#data`, `#issues`, `#rocks`, `#l10`, `#integrations`. Provide `navigate(hash)` and an `active` `NavLink`.
3.  **Theme**: Translate the Theme Guide into `tailwind.config.ts` `extend.colors` with keys `primary`, `primary-foreground`, `muted`, `accent`, `destructive`, `border`, `input`, `ring`, `background`, `foreground`. Inter as font. Use Tailwind utilities for spacing, shadows, transitions.
4.  **Charts**: Ignore any Chart.js references; implement all charts with Recharts wrappers in `/components/charts`.
5.  **Pages**: Create feature folders per page. Wire tRPC queries/mutations and forms via RHF+Zod.
6.  **Live updates**: Provide SSE endpoint `/api/sse` with heartbeat and event payloads; header shows status dot.

---

## OPTIONAL PACKS TO INCLUDE FOR THIS PROJECT

### Data & Database (Postgres + Prisma)

*   Packages: `@prisma/client@5.22.x`, `prisma@5.22.x`, `pg@8.x`.
*   Models:
    *   Auth: `User`, `Account`, `Session` (Auth.js)
    *   Domain:
        `Department { id, name, headId, memberCount }`
        `Employee { id, userId, departmentId, role }`
        `Rock { id, level enum('company','department','individual'), title, ownerId, departmentId, status enum('on_track','off_track','done'), dueAt }`
        `Issue { id, title, departmentId, priority int, status, createdAt }`
        `Todo { id, title, departmentId, assigneeId, doneAt }`
        `ScorecardMetric { id, name, departmentId?, unit, target, series JSONB }`
        `Meeting { id, departmentId?, date, rating, sentiment, summary, notes, recordingUrl }`
*   Seed: admin user, departments, employees, sample rocks/issues/todos, scorecard time series, two L10 meetings.

### Auth (Auth.js + Prisma adapter)

*   Packages: `next-auth@5.x`, `@auth/prisma-adapter@2.x`.
*   Strategy: email magic link.
*   Pages: `/app/(public)/auth/*`. Session in DB; secure cookies; CSRF.

### RBAC

*   Roles: `admin`, `manager`, `member`, `viewer`.
*   `rbac/guards.ts` exposes `canEditRock`, `canManageDepartment`, `canViewMeeting`, etc., all Zod-typed. Enforce in server procedures.

### Realtime (SSE)

*   `/api/sse`: emits `heartbeat` every 20s and `metric:update`, `rock:update`, `issue:update` events.
*   Client utility with auto-reconnect and backoff; header dot reflects status.

### Emails (React Email + Nodemailer via SES)

*   Packages: `react-email@2.x`, `@react-email/components@0.0.23`, `nodemailer@6.x`.
*   Templates: Magic Link, Meeting Recap. Local preview route.

### AI Utilities (server functions)

*   `lib/ai/summarize.ts` for dashboard analyst; `lib/ai/meetingInsights.ts` for L10 summaries.
*   Store outputs on `Meeting.summary` and `Meeting.sentiment`.

---

## OUTPUT REQUIREMENTS

1.  Generate `package.json`, `.env.example`, `.gitignore`, `.editorconfig`, `tsconfig.json`, `tailwind.config.ts`, `postcss.config.js`, ESLint + Prettier configs.
2.  Scaffold the directory structure exactly as above.
3.  Normalize the provided Anatomy and Theme into Tailwind tokens and components following the Normalization Rules.
4.  Include packs: Data & Database, Auth, RBAC, Realtime (SSE), Emails, AI Utilities.
5.  Prisma schema and seed as specified.
6.  tRPC `appRouter` with `healthcheck`, `whoami`, and routers: `dashboard`, `vto`, `departments`, `people`, `data`, `issues`, `rocks`, `l10`.
7.  One RHF+Zod form for “Add Rock,” with optimistic UI via React Query.
8.  Recharts wrappers themed for dark mode (`Line.tsx`, `Spark.tsx`).
9.  README with exact commands: install, migrate, dev, build, test.

## ACCEPTANCE CRITERIA

*   `pnpm install && pnpm dev` runs without errors.
*   `pnpm build` succeeds after `prisma generate`.
*   `pnpm test` passes.
*   Sign-in via magic link works locally.
*   Dashboard renders sample metrics with Recharts.
*   Add Rock modal saves via tRPC and revalidates list.
*   SSE indicator shows live connection and updates on events.
*   V/TO sections save and reload.
*   Department Detail shows scorecard, rocks, issues, todos, and recent L10 entries with recording links.

---

=== HTML_TO_NEXT_CONVERSION_RULES ===
---

# Add this “HTML → Next.js Conversion” block to your prompt

**Input context**
You are given a single-file HTML/Tailwind/Chart.js SPA (posted below). Convert it to the Universal Foundation stack (Next 15 + TS + Tailwind 3.4 + tRPC + Prisma + Recharts + Auth.js + React Query). No experimental flags. No CDN scripts. No inline API keys.

**Hard requirements**

1.  **Routing**
    *   Keep hash routes (`#dashboard`, `#vto`, `#departments`, `#departments/{id}`, `#people`, `#data`, `#issues`, `#rocks`, `#l10`, `#integrations`).
    *   Implement `src/components/layout/HashRouter.tsx` watching `window.location.hash` and rendering matching feature components.
    *   Sidebar links set `location.hash` and highlight the active item.

2.  **Layout & theming**
    *   Convert the HTML structure into React components:
        *   `src/components/layout/Sidebar.tsx`
        *   `src/components/layout/HeaderBar.tsx` (refresh button, live dot, avatar)
        *   `src/components/layout/Modal.tsx` (portal with focus trap)
        *   `src/app/layout.tsx` wraps everything; uses `next/font/google` for Inter.
    *   Move all inline `<style>` and custom CSS into `src/styles/globals.css` or Tailwind utilities.
    *   Tailwind via config (no CDN). Colors from the Theme Guide mapped to Tailwind tokens (`extend.colors`).

3.  **Icons & images**
    *   Replace ad-hoc SVG strings with **lucide-react** components (e.g., `Home`, `Target`, `Users`, `BarChart3`, `Bug`, `Mountain`, `Video`, `PlugZap`, `Bot`).

4.  **State & data**
    *   Replace the global `App` object and DOM mutation with React state and feature components.
    *   Preserve current demo data as a **seed** in `prisma/seed.ts`; also provide a **mock client store** for dev mode (`USE_MOCK=1`) so the UI runs without a DB.
    *   Migrate `localStorage` persistence to:
        *   short term: React Query cache + localStorage hydration (mock mode)
        *   long term: Prisma Postgres models per the Foundation (User, Department, Employee, Rock, Issue, Todo, ScorecardMetric, Meeting, etc.).

5.  **Forms & modals**
    *   Convert all form DOM access to **react-hook-form** + **zod** schemas with inline errors.
    *   Implement “Add/Edit Rock”, “Add/Edit Employee”, “Add Metric” as reusable RHF forms inside `Modal`.

6.  **Charts**
    *   Remove **Chart.js** completely. Rebuild:
        *   Dashboard sales trend ⇒ `<ResponsiveContainer><LineChart/></ResponsiveContainer>` (Recharts)
        *   Metric sparklines ⇒ small LineCharts (no axes, no legend)
    *   Use dark-mode friendly axis/tick styles and responsive containers.

7.  **Live updates**
    *   Replace the simulated webhook timers with an SSE endpoint:
        *   `src/app/api/sse/route.ts` emits `heartbeat`, `metric:update`, `rock:update`, `issue:update`.
        *   Header dot reflects connection (open/closed).

8.  **AI assistant**
    *   Remove the hardcoded Gemini endpoint + key.
    *   Create `src/app/api/ai/route.ts` that reads from `process.env.AI_PROVIDER` and **expects** a server key at runtime (do not commit).
    *   Client uses a simple chat state; messages are sanitized and rendered via React (no `innerHTML`).

9.  **Security**
    *   Eliminate direct `innerHTML` and dynamic string-to-DOM rendering. No `dangerouslySetInnerHTML` unless required, and if used, sanitize.
    *   Keep the original `Security.escapeHtml` idea but prefer typed state → JSX.

10. **RBAC**
    *   Add `rbac/roles.ts` and `rbac/guards.ts` with roles: `admin`, `manager`, `member`, `viewer`.
    *   Server-only enforcement inside tRPC procedures.

11. **Acceptance tests (must pass)**
    *   `pnpm dev` boots with mock data (no DB) and shows all pages via hash routing.
    *   `Add Rock` creates a rock and re-renders lists without refresh (React Query optimistic update).
    *   Dashboard charts render via Recharts; no Chart.js bundles in output.
    *   Live dot flips when SSE endpoint is stopped/started.
    *   No console errors in DevTools.

**Mapping table (from your HTML to files)**

| Source (HTML id/section) | Destination file/component |
| --- | --- |
| `aside#sidebar` + nav | `src/components/layout/Sidebar.tsx` |
| Header (refresh, status, avatar) | `src/components/layout/HeaderBar.tsx` |
| `#main-app` pages | `src/features/*` (one folder per page) |
| Rock modal / Employee modal / Metric modal | `src/components/layout/Modal.tsx` + `src/features/{rocks,people,data}/forms/*` |
| AI chat button + modal | `src/features/ai/Assistant.tsx` + `/api/ai/route.ts` |
| Chart canvases (`canvas` elements) | `src/components/charts/Line.tsx`, `Spark.tsx` (Recharts) |
| Local storage `Persistence` | React Query cache (mock) + Prisma DB (real) |
| `App.router()` + `window.hashchange` | `HashRouter.tsx` |
| “simulateWebhookUpdate” | SSE push + mock timers behind `USE_MOCK` |

**Specific replacements**

*   Inter font: use `next/font/google` (`const inter = Inter({ subsets: ['latin'], weight: ['400','500','600','700'] })`) and apply on `<body>`.
*   Remove `<script src="https://cdn.tailwindcss.com">` and `<script src="chart.js">`.
*   Replace custom SVG strings with `<IconName className="w-5 h-5" />` from lucide-react.
*   Replace DOM event listeners (`addEventListener`) with component-level handlers and controlled inputs.

**Config & env**

*   Add `.env.example` keys: `DATABASE_URL`, `AUTH_SECRET`, `EMAIL_SERVER_*` (if using email), `AI_PROVIDER`, `AI_API_KEY`.
*   Never hardcode API keys in the repo. Strip the Gemini key from input.

---

## Will it improve the project?

Yes—concretely in these ways:

*   **Performance & DX:** Next.js + App Router, code-splitting, zero CDN runtime hacks, strict TypeScript.
*   **Theming:** Proper Tailwind config (dark palette, Inter via next/font), consistent tokens.
*   **Charts:** Recharts with responsive containers and shared theming (lighter bundle than Chart.js for your use).
*   **Data & tests:** Prisma models + seed; mock mode for instant spin-up; unit (Vitest) + E2E (Playwright).
*   **Safety:** No raw `innerHTML`, input validated with Zod, RBAC on server.
*   **Realtime:** SSE status with reconnect; visible header indicator.
*   **AI:** Server-routed calls with pluggable provider; no leaked keys.

## One-liner you can paste above your HTML in the prompt

“Treat the following single-file HTML app as the source to migrate. Apply the rules in the ‘HTML → Next.js Conversion’ block and the Universal Foundation. Produce the complete Next.js project files, replacing Chart.js with Recharts, replacing DOM code with React components, and shipping mock mode + Prisma models. Ensure all Acceptance tests pass.”
```